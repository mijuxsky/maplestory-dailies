<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapleStory Dailies</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --radius:12px; --shadow:0 6px 16px rgba(0,0,0,.12); --ui:14px; --overlay:rgba(0,0,0,.55);}
    * { box-sizing:border-box; }
    body { font-family:Quicksand,system-ui,sans-serif; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; font-size:var(--ui); transition:.3s background,.3s color;}
    h1 { margin:0 0 6px; font-size:20px; }
    #utc-time { font-size:13px; margin-bottom:10px; }
    #instructions { position:relative; width:100%; max-width:900px; margin:10px 0 14px; padding:12px 14px 14px; border-radius:var(--radius); box-shadow:var(--shadow); }
    #instructions.minimized ul { display:none; }
    #instr-toggle { position:absolute; top:8px; right:10px; padding:4px 10px; font-size:12px; }
    select { padding:4px 8px; border-radius:8px; border:1px solid; background:transparent; outline:none; }
    option { background:inherit; color:inherit; }
    button { border:none; border-radius:8px; padding:6px 10px; margin:4px; cursor:pointer; font-weight:600; transition:.2s background,.2s color; }
    #checklists { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:20px; width:100%; max-width:1200px; align-items:start; }
    .character,.drop-placeholder { border-radius:var(--radius); box-shadow:var(--shadow); min-height:120px; position:relative; user-select:none; font-size:var(--ui); }
    .character { padding:68px 20px 16px; }
    .drop-placeholder { padding:68px 20px 16px; outline:2px dashed var(--ph-outline); outline-offset:-6px; background:var(--ph-bg); animation:ph .6s ease-in-out infinite alternate; }
    @keyframes ph { from{opacity:.72} to{opacity:1} }
    .window-controls-right { position:absolute; top:6px; right:8px; display:flex; gap:6px; align-items:center; }
    .icon-btn { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; padding:0; }
    .char-image-wrap { text-align:center; margin:8px auto 10px; }
    .char-image-wrap img { max-width:160px; max-height:160px; border-radius:8px; display:inline-block; }
    .char-name { width:100%; border:none; background:transparent; border-bottom:2px solid currentColor; text-align:center; font-weight:600; margin-bottom:8px; }
    .task { display:grid; grid-template-columns:18px 1fr auto; gap:8px; align-items:center; margin:8px 0; }
    .task input[type="text"] { border:none; border-bottom:1px dashed currentColor; background:transparent; padding:4px 2px; }
    .task .task-delete { background:transparent; border:none; font-size:16px; opacity:.7; }

    /* Modal (monochrome, legible, independent of theme) */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal-overlay.show { display:flex; }
    .modal { background:#fff; color:#222; border:1px solid #ddd; border-radius:12px; padding:16px 16px 14px; min-width:320px; max-width:520px; width:min(520px,92vw); box-shadow:0 10px 28px rgba(0,0,0,.22); }
    .modal h3 { margin:0 0 12px; font-size:18px; font-weight:700; color:#111; letter-spacing:.2px; }
    .modal .row { display:grid; grid-template-columns:1fr; gap:8px; margin:6px 0 10px; }
    .modal label { font-weight:600; font-size:12px; color:#333; }
    .modal input[type="text"] { width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; color:#111; }
    .modal .error { color:#b00020; min-height:18px; font-size:12px; margin-top:2px; }
    .modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
    .modal .actions button { padding:8px 12px; border-radius:8px; }
    .modal .actions #avatar-cancel { background:#f5f5f5; color:#222; border:1px solid #e5e5e5; }
    .modal .actions #avatar-search { background:#111; color:#fff; }

    /* Themes */
    body.light { --ph-outline:#9aa0a6; --ph-bg:rgba(0,0,0,.04); background:#f7f7f8; color:#333; }
    body.light #instructions, body.cloud #instructions, body.lavender #instructions { background:#fff; }
    body.light .character { background:#fff; }
    body.cloud { --ph-outline:#5a86b5; --ph-bg:rgba(90,134,181,.10); background:#eaf4ff; color:#2f4152; }
    body.cloud .character { background:#fff; border:1px solid #d6e7f7; }
    body.lavender { --ph-outline:#7c5db0; --ph-bg:rgba(124,93,176,.10); background:#f4f0fa; color:#4b3b60; }
    body.lavender .character { background:#fff; }
    body.matcha { --ph-outline:#4a8c4a; --ph-bg:rgba(74,140,74,.10); background:#f0faf2; color:#2f3b2f; }
    body.matcha .character { background:#e8f7ea; }
    body.dark { --ph-outline:#cfd3df; --ph-bg:rgba(207,211,223,.14); background:#12131a; color:#e6e7eb; }
    body.dark .character { background:#1f2230; }
    body.evergreen { --ph-outline:#8bcf9b; --ph-bg:rgba(139,207,155,.16); background:#0e1a11; color:#d9f2de; }
    body.evergreen .character { background:#1a2b1f; }
  </style>
</head>
<body class="lavender">
  <h1>MapleStory Dailies</h1>
  <div id="utc-time">Loading UTC time...</div>

  <div id="instructions">
    <button id="instr-toggle" type="button">Hide</button>
    <strong>How to use:</strong>
    <ul>
      <li>Presets switch between three saved sets of characters and tasks.</li>
      <li>+ Add Character (max 20). Each starts with two task lines (min 1, max 10).</li>
      <li>Enter/Tab/↓ to next task (auto-adds). ↑/Shift+Tab up. ←/→ at edges to switch cards.</li>
      <li>Click the camera icon on a card → enter <em>Character Name</em> → <em>Search For Character</em>. The avatar (from MapleRanks) replaces the base model above the name.</li>
      <li>Checkboxes reset at 00:00 UTC. Data is saved locally per preset.</li>
    </ul>
  </div>

  <div id="theme-selector">
    <label for="theme">Theme:</label>
    <select id="theme">
      <option value="light">Light Mode</option>
      <option value="cloud">Cloud (Light)</option>
      <option value="lavender">Lavender (Light)</option>
      <option value="matcha">Matcha (Light)</option>
      <option value="dark">Dark Mode</option>
      <option value="evergreen">Evergreen (Dark)</option>
    </select>
  </div>

  <div id="preset-selector">
    <label for="preset">Preset:</label>
    <select id="preset" onchange="switchPreset(this.value)">
      <option value="1">Preset 1</option>
      <option value="2">Preset 2</option>
      <option value="3">Preset 3</option>
    </select>
  </div>

  <div id="clipboard" aria-live="polite"></div>

  <div id="add-character">
    <button id="add-character-btn" title="Add Character">+ Add Character</button>
  </div>

  <div id="checklists"></div>

  <!-- Avatar search modal (no region) -->
  <div id="avatar-modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="avatar-modal-title" aria-modal="true">
      <h3 id="avatar-modal-title">Set Avatar</h3>
      <div class="row">
        <label for="avatar-name">Character Name</label>
        <input id="avatar-name" type="text" placeholder="Enter character name" />
      </div>
      <div id="avatar-error" class="error"></div>
      <div class="actions">
        <button id="avatar-cancel" type="button">Cancel</button>
        <button id="avatar-search" type="button">Search For Character</button>
      </div>
    </div>
  </div>

  <script>
    const PROXY_URL = "https://ms-avatar-proxy.meehoowee.workers.dev/";
    const BASE_MODEL_URL = "https://maplestory.io/api/character/%7B%22itemId%22%3A2000%2C%22version%22%3A%22250%22%7D%2C%7B%22itemId%22%3A12000%2C%22version%22%3A%22250%22%7D/stand1/0?showears=false&showLefEars=false&showHighLefEars=undefined&resize=1&name=&flipX=undefined";

    let currentPreset = 1;
    const maxCharacters = 20;
    const maxTasks = 10;
    let dragFrom = null, dropPlaceholder = null, avatarTargetIndex = null;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function getDataKey() { return `mapleData_preset${currentPreset}`; }
    function loadData() { return JSON.parse(localStorage.getItem(getDataKey())) || { charCount: 0 }; }
    function saveData(d) { localStorage.setItem(getDataKey(), JSON.stringify(d)); }
    function dailyKey(c,t) { return `mapleCheck_${new Date().toISOString().split('T')[0]}_preset${currentPreset}_c${c}_t${t}`; }

    function exportCharacters(d) {
      const list = []; const n = d.charCount||0;
      for (let i=0;i<n;i++) {
        const ct = Math.max(1, d[`char_${i}_taskCount`]||1);
        const tasks=[]; for (let t=0;t<ct;t++) tasks.push(d[`char_${i}_task_${t}`]||"");
        list.push({ name:d[`char_${i}_name`]||"", image:d[`char_${i}_image`]||"", tasks });
      }
      return list;
    }
    function importCharacters(chars) {
      const d={}; d.charCount=chars.length;
      for (let i=0;i<chars.length;i++) {
        d[`char_${i}_name`]=chars[i].name||"";
        d[`char_${i}_image`]=chars[i].image||"";
        d[`char_${i}_taskCount`]=Math.max(1, Math.min(maxTasks,(chars[i].tasks||[]).length||1));
        for (let t=0;t<d[`char_${i}_taskCount`];t++) d[`char_${i}_task_${t}`]=chars[i].tasks[t]||"";
      }
      saveData(d);
    }
    function moveCharacter(fr,to) {
      const d=loadData(); const arr=exportCharacters(d);
      if (fr===null||to===null||fr===to) return;
      const it=arr.splice(fr,1)[0]; arr.splice(to,0,it);
      importCharacters(arr); buildChecklists();
    }
    function ensurePlaceholder() { if(!dropPlaceholder){dropPlaceholder=document.createElement('div');dropPlaceholder.className='drop-placeholder';} return dropPlaceholder; }
    function removePlaceholder() { if(dropPlaceholder&&dropPlaceholder.parentElement) dropPlaceholder.parentElement.removeChild(dropPlaceholder); }

    function addTaskLine(card,d,c) {
      let count=d[`char_${c}_taskCount`]||1;
      if(count<maxTasks){ d[`char_${c}_taskCount`]=count+1; saveData(d); return createTaskLine(card,d,c,count); }
      return null;
    }
    function focusTaskAt(card,idx){
      const arr=Array.from(card.querySelectorAll('.task input[type="text"]'));
      if(idx>=0&&idx<arr.length){ arr[idx].focus(); const e=arr[idx].value.length; arr[idx].setSelectionRange(e,e); return true;}
      return false;
    }
    function focusFirstTaskInCard(card){
      const el = card.querySelector('.task input[type="text"]') || card.querySelector('.char-name');
      if(el){ el.focus(); const e=el.value.length; el.setSelectionRange?.(e,e); return true; }
      return false;
    }
    function focusCardByOffset(card,off){
      const cards=$$('.character'); const i=cards.indexOf(card); const nx=i+off;
      if(nx<0||nx>=cards.length) return false;
      return focusFirstTaskInCard(cards[nx]);
    }

    async function fetchAvatar(name) {
      const resp = await fetch(`${PROXY_URL}?name=${encodeURIComponent(name)}`);
      if(!resp.ok) throw new Error('Avatar fetch failed');
      const data = await resp.json();
      if(!data.imageUrl) throw new Error('No image in response');
      return data.imageUrl;
    }

    function createTaskLine(card,d,c,t){
      const wrap=document.createElement('div'); wrap.className='task';
      const cb=document.createElement('input'); cb.type='checkbox';
      const key=dailyKey(c,t); cb.checked=(localStorage.getItem(key)==='true');
      cb.onchange=()=>localStorage.setItem(key, cb.checked?'true':'false');
      const input=document.createElement('input'); input.type='text'; input.placeholder='Daily Task'; input.value=d[`char_${c}_task_${t}`]||"";
      input.addEventListener('keydown',e=>{
        const inputs=Array.from(card.querySelectorAll('.task input[type="text"]')); const idx=inputs.indexOf(input);
        const atStart=input.selectionStart===0&&input.selectionEnd===0; const atEnd=input.selectionStart===input.value.length&&input.selectionEnd===input.value.length;
        if(e.key==='Enter'||(e.key==='Tab'&&!e.shiftKey)||(e.key==='ArrowDown'&&atEnd)){ if(e.key!=='ArrowDown') e.preventDefault(); if(!focusTaskAt(card,idx+1)){ const ni=addTaskLine(card,d,c); if(ni) ni.focus(); } }
        else if((e.key==='Tab'&&e.shiftKey)||(e.key==='ArrowUp'&&atStart)){ e.preventDefault(); if(!focusTaskAt(card,idx-1)) (card.querySelector('.char-name')||{}).focus?.(); }
        else if(e.key==='ArrowRight'&&atEnd){ e.preventDefault(); focusCardByOffset(card,+1); }
        else if(e.key==='ArrowLeft'&&atStart){ e.preventDefault(); focusCardByOffset(card,-1); }
      });
      input.addEventListener('input',()=>{ if(input.value===""){ const ct=d[`char_${c}_taskCount`]||1; if(ct>1){ wrap.remove(); delete d[`char_${c}_task_${t}`]; d[`char_${c}_taskCount`]=Math.max(1,ct-1); saveData(d);} else { delete d[`char_${c}_task_${t}`]; saveData(d);} } else { d[`char_${c}_task_${t}`]=input.value; saveData(d);} });
      const del=document.createElement('button'); del.className='task-delete'; del.title='Delete Task'; del.textContent='×';
      del.onclick=()=>{ const ct=d[`char_${c}_taskCount`]||1; if(ct>1){ wrap.remove(); delete d[`char_${c}_task_${t}`]; d[`char_${c}_taskCount`]=Math.max(1,ct-1); saveData(d);} else { input.value=""; delete d[`char_${c}_task_${t}`]; saveData(d);} };
      wrap.append(cb,input,del); card.appendChild(wrap); return input;
    }

    function showCharImage(card,src){ const img=card.querySelector('.char-image-wrap img'); img.src=src||BASE_MODEL_URL; }

    function buildChecklists(){
      const container=document.getElementById('checklists'); container.innerHTML=''; removePlaceholder();
      const d=loadData();
      for(let c=0;c<(d.charCount||0);c++){
        const card=document.createElement('div'); card.className='character'; card.setAttribute('draggable','true'); card.dataset.index=c;
        card.addEventListener('dragstart',e=>{ dragFrom=c; card.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
        card.addEventListener('dragend',()=>{ dragFrom=null; card.classList.remove('dragging'); removePlaceholder(); });
        card.addEventListener('dragover',e=>{ e.preventDefault(); const rect=card.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; const ph=ensurePlaceholder(); if(before){ if(ph.nextSibling!==card) container.insertBefore(ph,card);} else { if(card.nextSibling!==ph) container.insertBefore(ph,card.nextSibling);} });
        card.addEventListener('drop',e=>{ e.preventDefault(); const kids=Array.from(container.children); let target=0; for(const node of kids){ if(node===dropPlaceholder) break; if(node.classList.contains('character')) target++; } removePlaceholder(); moveCharacter(dragFrom,target); });

        const topRight=document.createElement('div'); topRight.className='window-controls-right';
        const cam=document.createElement('button'); cam.className='icon-btn'; cam.title='Set Avatar'; cam.innerHTML='<svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 3l-1.5 2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2.5L15 3H9zm3 4a5 5 0 1 1 0 10a5 5 0 0 1 0-10z"/></svg>';
        cam.onclick=()=>openAvatarModal(c,(loadData()[`char_${c}_name`]||""));
        const dup=document.createElement('button'); dup.className='icon-btn'; dup.title='Duplicate'; dup.innerHTML='<svg viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H6a2 2 0 0 0-2 2v10h2V3h10V1zm-4 4h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H12a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm0 2v10h8V7h-8z"/></svg>';
        dup.onclick=()=>duplicateCharacter(c);
        const close=document.createElement('button'); close.className='icon-btn'; close.title='Delete'; close.innerHTML='&times;';
        close.onclick=()=>deleteCharacter(c);
        topRight.append(cam,dup,close);
        card.appendChild(topRight);

        const imgWrap=document.createElement('div'); imgWrap.className='char-image-wrap'; imgWrap.innerHTML='<img alt="Character image" />'; card.appendChild(imgWrap);
        const cachedImg=(d[`char_${c}_image`]||"").trim(); showCharImage(card, cachedImg || BASE_MODEL_URL);

        const name=document.createElement('input'); name.className='char-name'; name.placeholder='Character Name'; name.value=d[`char_${c}_name`]||"";
        name.addEventListener('input',()=>{ const dd=loadData(); dd[`char_${c}_name`]=name.value; saveData(dd); });
        name.addEventListener('keydown',e=>{ const atStart=name.selectionStart===0&&name.selectionEnd===0; const atEnd=name.selectionStart===name.value.length&&name.selectionEnd===name.value.length;
          if(e.key==='Enter'){ e.preventDefault(); (card.querySelector('.task input[type="text"]')||{}).focus?.(); }
          else if(e.key==='ArrowRight'&&atEnd){ e.preventDefault(); focusCardByOffset(card,+1); }
          else if(e.key==='ArrowLeft'&&atStart){ e.preventDefault(); focusCardByOffset(card,-1); }
        });
        card.appendChild(name);

        let count=d[`char_${c}_taskCount`]; if(count==null) count=2; if(count<1) count=1; d[`char_${c}_taskCount`]=count;
        for(let t=0;t<count;t++) createTaskLine(card,d,c,t);
        saveData(d);
        container.appendChild(card);
      }
    }

    function addCharacter(){
      const d=loadData(); if((d.charCount||0)>=20) return alert('Maximum of 20 characters reached.');
      const c=d.charCount||0; d.charCount=c+1; d[`char_${c}_taskCount`]=2; saveData(d); buildChecklists();
    }
    function duplicateCharacter(i){
      const d=loadData(); if((d.charCount||0)>=20) return alert('Maximum of 20 characters reached.');
      const arr=exportCharacters(d); const clone=JSON.parse(JSON.stringify(arr[i])); arr.splice(i+1,0,clone); importCharacters(arr); buildChecklists(); document.getElementById('clipboard').textContent='Character duplicated.';
    }
    function deleteCharacter(i){ const d=loadData(); const arr=exportCharacters(d); arr.splice(i,1); importCharacters(arr); buildChecklists(); }
    function switchPreset(p){ currentPreset=p; buildChecklists(); }

    function updateUTCTime(){
      const n=new Date(); const y=n.getUTCFullYear(); const m=String(n.getUTCMonth()+1).padStart(2,'0'); const d=String(n.getUTCDate()).padStart(2,'0'); const hh=String(n.getUTCHours()).padStart(2,'0'); const mm=String(n.getUTCMinutes()).padStart(2,'0'); const ss=String(n.getUTCSeconds()).padStart(2,'0');
      document.getElementById('utc-time').textContent=`UTC Time: ${m}/${d}/${y} ${hh}:${mm}:${ss}`;
    }
    setInterval(updateUTCTime,1000);

    function loadTheme(){ const t=localStorage.getItem('mapleTheme')||'lavender'; document.body.className=t; document.getElementById('theme').value=t; }
    document.getElementById('theme').addEventListener('change',function(){ document.body.className=this.value; localStorage.setItem('mapleTheme',this.value); });

    // Instructions toggle
    const instr=document.getElementById('instructions'); const toggle=document.getElementById('instr-toggle');
    function setInstr(min){ instr.classList.toggle('minimized',min); toggle.textContent=min?'Unhide':'Hide'; localStorage.setItem('mapleInstrMin',min?'1':'0'); }
    toggle.onclick=()=>setInstr(!instr.classList.contains('minimized'));
    setInstr(localStorage.getItem('mapleInstrMin')==='1');

    // Modal logic
    const overlay=document.getElementById('avatar-modal-overlay');
    const nameInput=document.getElementById('avatar-name');
    const errBox=document.getElementById('avatar-error');
    function openAvatarModal(cardIndex,prefill){ avatarTargetIndex=cardIndex; errBox.textContent=""; nameInput.value=prefill||""; overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); nameInput.focus(); nameInput.select(); }
    function closeAvatarModal(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); avatarTargetIndex=null; }
    document.getElementById('avatar-cancel').onclick=closeAvatarModal;
    document.getElementById('avatar-search').onclick=()=>doAvatarSearch();
    nameInput.addEventListener('keydown',e=>{ if(e.key==='Enter') doAvatarSearch(); });
    async function doAvatarSearch(){
      errBox.textContent=""; const nm=nameInput.value.trim();
      if(!nm) return errBox.textContent='Please enter a character name.';
      try{ const url=await fetchAvatar(nm); const cards=$$('.character'); const card=cards[avatarTargetIndex]; if(!card) throw new Error('Card not found'); const d=loadData(); d[`char_${avatarTargetIndex}_image`]=url; saveData(d); showCharImage(card,url); closeAvatarModal(); }
      catch(e){ errBox.textContent='Character image not found. Please verify the name and retry.'; }
    }

    document.getElementById('add-character-btn').onclick=addCharacter;

    switchPreset(1); loadTheme(); updateUTCTime(); buildChecklists();
  </script>
</body>
</html>
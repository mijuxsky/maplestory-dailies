<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MapleStory Dailies</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s, color 0.3s;
    }
    h1 { margin-bottom: 5px; }
    #utc-time { margin-bottom: 10px; font-size: 14px; }
    #theme-selector, #preset-selector { margin-bottom: 15px; }
    button {
      background: #cbb7f0; border: none; border-radius: 6px;
      padding: 6px 12px; margin: 4px; cursor: pointer; font-weight: 600;
    }
    button:hover { background: #b7a1e1; }
    #checklists {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 20px; width: 100%; max-width: 1200px;
    }
    #add-character {
      align-self: flex-end; margin: 10px 0;
    }
    .character {
      border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 15px 20px; width: 220px; flex-shrink: 0; position: relative;
      background: #fff;
    }
    .character input.char-name {
      font-size: 16px; font-weight: bold; border: none; background: transparent;
      border-bottom: 2px solid #ccc; margin-bottom: 10px; width: 100%; text-align: center;
    }
    .char-img {
      display: block; margin: 0 auto 10px auto; max-height: 100px;
    }
    .task { display: flex; align-items: center; margin: 6px 0; }
    .task input[type="checkbox"] { margin-right: 8px; }
    .task input[type="text"] {
      border: none; border-bottom: 1px solid #ccc; flex: 1; background: transparent;
    }
    .delete-btn {
      position: absolute; top: 5px; right: 5px;
      background: #f8cdd1; color: #333; border: none; border-radius: 50%;
      width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 18px; text-align: center;
    }
    .delete-btn:hover { background: #f59ca4; }
    .delete-btn[title] {
      position: relative;
    }
    #theme, #preset {
      padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit;
    }
    /* Themes */
    body.light { background: #f9f9f9; color: #333; }
    body.light h1 { color: #444; }
    body.light .task input[type="checkbox"] { accent-color: #777; }
    body.dark { background: #1e1e2e; color: #e5e5e5; }
    body.dark h1 { color: #ddd; }
    body.dark .character { background: #2b2b3c; }
    body.dark .task input[type="checkbox"] { accent-color: #bbb; }
    body.cloud { background: #f0f8ff; color: #3a4a5a; }
    body.cloud h1 { color: #5a86b5; }
    body.cloud .character { background: #ffffff; border: 1px solid #dce6f0; }
    body.cloud .task input[type="checkbox"] { accent-color: #5a86b5; }
    body.lavender { background: #f4f0fa; color: #4b3b60; }
    body.lavender h1 { color: #7c5db0; }
    body.lavender .task input[type="checkbox"] { accent-color: #7c5db0; }
  </style>
</head>
<body>
  <h1>MapleStory Dailies</h1>
  <div id="utc-time">Loading UTC time...</div>

  <div id="theme-selector">
    <label for="theme">Theme:</label>
    <select id="theme">
      <option value="light">Light Mode</option>
      <option value="dark">Dark Mode</option>
      <option value="cloud">Cloud</option>
      <option value="lavender">Lavender</option>
    </select>
  </div>

  <div id="preset-selector">
    <label for="preset">Preset:</label>
    <select id="preset" onchange="switchPreset(this.value)">
      <option value="1">Preset 1</option>
      <option value="2">Preset 2</option>
      <option value="3">Preset 3</option>
    </select>
  </div>

  <div id="add-character">
    <button onclick="addCharacter()">+ Add Character</button>
  </div>

  <div id="checklists"></div>

  <script>
    let currentPreset = 1;
    const maxCharacters = 20;
    const maxTasks = 10;

    function getStorageKey() {
      const today = new Date().toISOString().split('T')[0];
      return `mapleDailies_preset${currentPreset}_${today}`;
    }
    function getDataKey() { return `mapleData_preset${currentPreset}`; }
    function loadData() { return JSON.parse(localStorage.getItem(getDataKey())) || { charCount: 0 }; }
    function saveData(data) { localStorage.setItem(getDataKey(), JSON.stringify(data)); }

    function buildChecklists() {
      const checklistContainer = document.getElementById('checklists');
      checklistContainer.innerHTML = '';
      const data = loadData();
      for (let c = 0; c < (data.charCount || 0); c++) {
        const charBox = document.createElement('div');
        charBox.className = "character";

        const delBtn = document.createElement('button');
        delBtn.className = "delete-btn";
        delBtn.textContent = "Ã—";
        delBtn.title = "Delete Character";
        delBtn.onclick = () => { deleteCharacter(c); };
        charBox.appendChild(delBtn);

        const charName = document.createElement('input');
        charName.className = "char-name";
        charName.placeholder = "Character Name";
        charName.value = data[`char_${c}_name`] || "";
        charName.addEventListener("blur", () => {
          data[`char_${c}_name`] = charName.value; saveData(data);
          loadCharacterImage(charBox, c, charName.value);
        });
        charBox.appendChild(charName);

        const charImg = document.createElement('img');
        charImg.className = "char-img";
        charImg.id = `charimg_${c}`;
        if (data[`char_${c}_img`]) charImg.src = data[`char_${c}_img`];
        charBox.appendChild(charImg);

        const taskCount = data[`char_${c}_taskCount`] || 2;
        for (let t = 0; t < taskCount; t++) {
          createTaskLine(charBox, data, c, t);
        }
        checklistContainer.appendChild(charBox);
      }
    }

    function createTaskLine(charBox, data, c, t) {
      const wrapper = document.createElement('div');
      wrapper.className = "task";
      const id = `preset${currentPreset}_char${c}_task${t}`;
      const storageKey = getStorageKey() + "_" + id;
      const savedChecked = localStorage.getItem(storageKey) === "true";

      const checkbox = document.createElement('input');
      checkbox.type = "checkbox"; checkbox.checked = savedChecked;
      checkbox.addEventListener("change", () => { localStorage.setItem(storageKey, checkbox.checked); });

      const taskInput = document.createElement('input');
      taskInput.type = "text"; taskInput.placeholder = "Daily Task";
      taskInput.value = data[`char_${c}_task_${t}`] || "";
      taskInput.addEventListener("input", () => {
        if (taskInput.value === "") {
          wrapper.remove();
          delete data[`char_${c}_task_${t}`];
          data[`char_${c}_taskCount`] = (data[`char_${c}_taskCount`] || 2) - 1;
          saveData(data);
        } else {
          data[`char_${c}_task_${t}`] = taskInput.value; saveData(data);
        }
      });
      taskInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          let taskCount = data[`char_${c}_taskCount`] || 2;
          if (taskCount < maxTasks) {
            data[`char_${c}_taskCount`] = taskCount + 1;
            saveData(data);
            createTaskLine(charBox, data, c, taskCount);
          }
        }
      });

      wrapper.appendChild(checkbox); wrapper.appendChild(taskInput);
      charBox.appendChild(wrapper);
    }

    function addCharacter() {
      const data = loadData();
      if (data.charCount >= maxCharacters) { alert("Maximum of 20 characters reached."); return; }
      const c = data.charCount;
      data.charCount = (data.charCount || 0) + 1;
      data[`char_${c}_taskCount`] = 2;
      saveData(data); buildChecklists();
    }

    function deleteCharacter(index) {
      const data = loadData();
      for (let i = index; i < data.charCount - 1; i++) {
        data[`char_${i}_name`] = data[`char_${i+1}_name`] || "";
        data[`char_${i}_taskCount`] = data[`char_${i+1}_taskCount`] || 2;
        for (let t = 0; t < maxTasks; t++) {
          data[`char_${i}_task_${t}`] = data[`char_${i+1}_task_${t}`] || "";
        }
      }
      delete data[`char_${data.charCount-1}_name`];
      for (let t = 0; t < maxTasks; t++) delete data[`char_${data.charCount-1}_task_${t}`];
      delete data[`char_${data.charCount-1}_taskCount`];
      data.charCount = data.charCount - 1;
      saveData(data); buildChecklists();
    }

    function loadCharacterImage(charBox, c, name) {
      const img = charBox.querySelector(`#charimg_${c}`);
      if (!name) { img.src = ""; return; }
      const url = `https://maplestory.io/api/character/gms/${encodeURIComponent(name)}/stand/0`;
      img.src = url;
      img.onerror = () => { img.src = ""; };
      const data = loadData();
      data[`char_${c}_img`] = url;
      saveData(data);
    }

    function switchPreset(preset) {
      currentPreset = preset;
      buildChecklists();
    }

    function updateUTCTime() {
      const now = new Date();
      const utcYear = now.getUTCFullYear();
      const utcMonth = String(now.getUTCMonth() + 1).padStart(2, '0');
      const utcDay = String(now.getUTCDate()).padStart(2, '0');
      const utcHours = String(now.getUTCHours()).padStart(2, '0');
      const utcMinutes = String(now.getUTCMinutes()).padStart(2, '0');
      const utcSeconds = String(now.getUTCSeconds()).padStart(2, '0');
      document.getElementById('utc-time').innerText =
        `UTC Time: ${utcMonth}/${utcDay}/${utcYear} ${utcHours}:${utcMinutes}:${utcSeconds}`;
    }
    setInterval(updateUTCTime, 1000);

    function loadTheme() {
      const savedTheme = localStorage.getItem("mapleTheme") || "lavender";
      document.body.className = savedTheme;
      document.getElementById("theme").value = savedTheme;
    }
    document.getElementById("theme").addEventListener("change", function() {
      const theme = this.value; document.body.className = theme;
      localStorage.setItem("mapleTheme", theme);
    });

    switchPreset(1);
    loadTheme();
    updateUTCTime();
  </script>
</body>
</html>
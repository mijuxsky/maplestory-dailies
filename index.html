<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MapleStory Dailies</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* ===== Theme tokens ===== */
  :root{
    --radius:12px; --shadow:0 6px 16px rgba(0,0,0,.12);
    --ui:14px; --overlay:rgba(0,0,0,.55);
    --bg:#f4f0fa; --fg:#4b3b60;
    --card-bg:#ffffff; --card-border:#e6def6;
    --control-bg:#ffffff; --control-fg:#4b3b60; --control-border:#cfc4ea;
    --button-bg:#e7def7; --button-fg:#3c2e54; --button-border:#cfc4ea;
    --icon:#7c5db0; --icon-hover:rgba(124,93,176,.14);
    --task-underline:1px dotted currentColor;
    --name-underline:1px solid currentColor;
    --meta-fg:#6b7280; --handle-fg: var(--meta-fg);
    --popover-bg:var(--card-bg); --popover-fg:var(--fg); --popover-border:var(--card-border);
    --kbd-focus: var(--icon);
    --danger:#E57373;
    --accent:#7c5db0; --accent-tint: rgba(124,93,176,.10);
    --muted:#7a7f8f;
    --line-height:1.45; --letter-spacing:normal;
    --keycap-bg: var(--control-bg); --keycap-fg: var(--control-fg); --keycap-border: var(--control-border);
    --toast-bg: rgba(0,0,0,.75); --toast-fg: #fff;
  }
  body.light{ --bg:#f7f7f8; --fg:#333; --card-bg:#fff; --card-border:#e7e7ea; --control-bg:#fff; --control-fg:#222; --control-border:#d8d8dc; --button-bg:#ededf1; --button-fg:#222; --button-border:#d8d8dc; --icon:#555; --icon-hover:rgba(0,0,0,.07); --meta-fg:#6b7280; --handle-fg:#7b8190; --danger:#D46B6B; --accent:#444; --accent-tint:rgba(0,0,0,.06); --keycap-bg:#f5f5f7; --keycap-fg:#222; --keycap-border:#d8d8dc; --toast-bg:rgba(0,0,0,.8); }
  body.cloud{ --bg:#eaf4ff; --fg:#2f4152; --card-bg:#fff; --card-border:#d6e7f7; --control-bg:#f6fbff; --control-fg:#2f4152; --control-border:#c7def2; --button-bg:#dcebfb; --button-fg:#213444; --button-border:#c4dcf5; --icon:#5a86b5; --icon-hover:rgba(90,134,181,.14); --meta-fg:#6b7280; --handle-fg:#5a86b5; --danger:#D36A6A; --accent:#5a86b5; --accent-tint:rgba(90,134,181,.12); --keycap-bg:#eef6ff; --keycap-fg:#213444; --keycap-border:#c7def2; }
  body.lavender{ --bg:#f4f0fa; --fg:#4b3b60; --card-bg:#fff; --card-border:#e6def6; --control-bg:#fff; --control-fg:#4b3b60; --control-border:#cfc4ea; --button-bg:#e7def7; --button-fg:#3c2e54; --button-border:#cfc4ea; --icon:#7c5db0; --icon-hover:rgba(124,93,176,.14); --meta-fg:#6b7280; --handle-fg:#7c5db0; --danger:#E57373; --accent:#7c5db0; --accent-tint:rgba(124,93,176,.12); --keycap-bg:#f2ecfb; --keycap-fg:#3c2e54; --keycap-border:#cfc4ea; }
  body.matcha{ --bg:#f0faf2; --fg:#2f3b2f; --card-bg:#e8f7ea; --card-border:#cfead4; --control-bg:#f7fdf8; --control-fg:#2f3b2f; --control-border:#cfead4; --button-bg:#d9f0de; --button-fg:#243224; --button-border:#c6e4cc; --icon:#4a8c4a; --icon-hover:rgba(74,140,74,.14); --meta-fg:#64748b; --handle-fg:#4a8c4a; --danger:#D06E6E; --accent:#4a8c4a; --accent-tint:rgba(74,140,74,.12); --keycap-bg:#eff8f0; --keycap-fg:#243224; --keycap-border:#c6e4cc; }
  body.dark{ --bg:#12131a; --fg:#e6e7eb; --card-bg:#1f2230; --card-border:#2c3144; --control-bg:#171925; --control-fg:#e6e7eb; --control-border:#2c3144; --button-bg:#2a2e42; --button-fg:#e6e7eb; --button-border:#3a4161; --icon:#cfd3df; --icon-hover:rgba(255,255,255,.09); --meta-fg:#cbd5e1; --handle-fg:#cfd3df; --popover-bg:#1c2030; --popover-fg:#e6e7eb; --popover-border:#2c3144; --kbd-focus:#8bcf9b; --danger:#FF8A80; --accent:#cfd3df; --accent-tint:rgba(207,211,223,.12); --keycap-bg:#2a2e42; --keycap-fg:#e6e7eb; --keycap-border:#3a4161; --toast-bg:#0b0c12cc; }
  body.evergreen{ --bg:#0e1a11; --fg:#d9f2de; --card-bg:#1a2b1f; --card-border:#25402d; --control-bg:#132417; --control-fg:#d9f2de; --control-border:#284833; --button-bg:#23402c; --button-fg:#d9f2de; --button-border:#2e5640; --icon:#8bcf9b; --icon-hover:rgba(139,207,155,.15); --meta-fg:#d1d5db; --handle-fg:#8bcf9b; --popover-bg:#15261b; --popover-fg:#d9f2de; --popover-border:#2e5640; --kbd-focus:#8bcf9b; --danger:#FF9A8D; --accent:#8bcf9b; --accent-tint:rgba(139,207,155,.14); --keycap-bg:#23402c; --keycap-fg:#d9f2de; --keycap-border:#2e5640; --toast-bg:#09140bcc; }

  /* ===== Base ===== */
  *{box-sizing:border-box}
  body{font-family:Quicksand,system-ui,sans-serif;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;font-size:var(--ui);background:var(--bg);color:var(--fg);transition:.25s background,.25s color;line-height:var(--line-height);letter-spacing:var(--letter-spacing)}
  h1{margin:0 0 6px;font-size:20px;text-align:center}
  #utc-time{font-size:13px;margin-bottom:8px}

  /* ===== Controls ===== */
  .top-bar{display:flex;gap:10px;align-items:center;width:100%;max-width:1000px;margin:4px 0 8px}
  .select-wrap{position:relative;display:inline-flex;align-items:center}
  .select-wrap::after{content:'▾';position:absolute;right:10px;pointer-events:none;opacity:.8;color:var(--control-fg);font-size:12px}
  select{appearance:none;padding:6px 28px 6px 10px;border-radius:10px;border:1px solid var(--control-border);background:var(--control-bg);color:var(--control-fg);outline:none;font-family:inherit;font-size:var(--ui)}
  option{background:var(--control-bg);color:var(--control-fg)}
  label{font-weight:600;font-size:var(--ui);opacity:.9;font-family:inherit}

  .toolbar{display:flex;align-items:center;gap:12px;width:100%;max-width:1000px;margin:8px 0 12px;flex-wrap:wrap}
  .toolbar .left{display:flex;align-items:center;gap:10px;margin-right:auto}
  .toolbar .right{display:flex;align-items:center;gap:8px;margin-left:auto;position:relative;flex-wrap:wrap}

  .btn{padding:8px 12px;border-radius:10px;background:var(--button-bg);color:var(--button-fg);border:1px solid var(--button-border);font-weight:600;font-family:inherit;font-size:var(--ui);cursor:pointer}
  .btn:hover{filter:brightness(1.02)}
  .btn:active{transform:translateY(1px)}

  .icon-btn{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0;border:1px solid var(--control-border);background:var(--control-bg);color:var(--icon);transition:.15s;cursor:pointer}
  .icon-btn:hover{background:var(--icon-hover)}
  .icon-btn.small{width:24px;height:24px;border-radius:6px}
  .icon-btn svg{width:16px;height:16px}

  .inline-msg{font-size:12px;color:var(--danger);margin-top:4px}

  /* Preset UI */
  .preset-inline{display:flex;align-items:center;gap:8px}
  #preset-count{font-size:12px;color:var(--meta-fg)}
  .mini-menu{position:absolute;right:0;top:38px;background:var(--popover-bg);color:var(--popover-fg);border:1px solid var(--popover-border);border-radius:10px;box-shadow:var(--shadow);padding:6px 0;display:none;z-index:100}
  .mini-menu.show{display:block}
  .mini-menu button{display:block;width:100%;padding:8px 12px;background:transparent;border:none;color:inherit;text-align:left;font:inherit;cursor:pointer}
  .mini-menu button[disabled]{opacity:.5;cursor:not-allowed}
  .mini-menu button:hover:not([disabled]){background:var(--icon-hover)}
  .preset-limit-note{font-size:12px;color:var(--danger);margin-left:auto}

  /* Instructions */
  #instructions{position:relative;width:100%;max-width:1000px;margin:10px 0 10px;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);background:var(--card-bg);border:1px solid var(--card-border)}
  #instr-toggle{position:absolute;top:8px;right:10px;padding:4px 10px;font-size:12px;background:var(--button-bg);color:var(--button-fg);border:1px solid var(--button-border);border-radius:8px;cursor:pointer;font-family:inherit}
  #instructions p{margin:0 0 6px}
  #instructions ol{margin:0;padding-left:18px}
  #instructions li{margin:4px 0}

  /* Cards */
  #checklists{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;width:100%;max-width:1000px;align-items:start}
  .character{border-radius:12px;box-shadow:var(--shadow);min-height:120px;position:relative;user-select:none;font-size:var(--ui);background:var(--card-bg);border:1px solid var(--card-border);padding:40px 16px 12px;transition:transform .22s ease,box-shadow .22s ease}
  .window-controls-right{position:absolute;top:6px;right:8px;display:flex;gap:6px;align-items:center}
  .window-controls-left{position:absolute;top:6px;left:8px;display:flex;gap:6px;align-items:center}
  .card-drag-handle{position:absolute;left:14px;right:14px;top:30px;height:18px;cursor:grab;user-select:none;opacity:0;border:none}
  .char-image-wrap{text-align:center;margin:2px auto 2px;min-height:24px}
  .char-image-wrap img{max-width:150px;max-height:110px;border-radius:8px;display:inline-block}
  .char-meta{text-align:center;font-size:12px;color:var(--meta-fg);margin:0 0 2px;font-family:inherit;min-height:16px}

  .name-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .char-name{width:100%;border:none;background:transparent;border-bottom:var(--name-underline);text-align:center;font-weight:600;margin:0 0 2px;font-size:var(--ui);color:var(--fg);font-family:inherit}
  .char-name:focus{outline:none;box-shadow:0 0 0 2px var(--kbd-focus)/2}

  .tasks{margin-top:2px}
  .task{position:relative;display:grid;grid-template-columns:12px 1fr 22px 14px;gap:8px;align-items:center;margin:6px 0}
  .task input[type="text"]{border:none;border-bottom:var(--task-underline);background:transparent;padding:2px 2px;font-size:var(--ui);color:var(--fg);font-family:inherit}
  .task input[type="text"]:focus{outline:none;box-shadow:none}
  .task .task-delete{background:transparent;border:none;font-size:16px;opacity:.7;color:var(--icon);width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .task input[type="checkbox"]{width:12px;height:12px;vertical-align:middle}
  .handle{cursor:grab;user-select:none;opacity:.7}
  .handle:active{cursor:grabbing}

  .check-all{display:flex;align-items:center;gap:8px;margin:8px 0 0;font-size:12px;color:var(--muted);font-weight:700}
  .check-all label{color:var(--muted)}

  /* Modals */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal-overlay.show{display:flex}
  .modal{background:#fff;color:#111;border:1px solid #ddd;border-radius:12px;padding:16px 16px 14px;min-width:320px;max-width:560px;width:min(560px,92vw);box-shadow:0 10px 28px rgba(0,0,0,.22);font-family:inherit}
  .modal h3{margin:0 0 12px;font-size:18px;font-weight:700}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .btn.secondary{background:#f5f5f5;color:#111;border-color:#e5e5e5}

  /* Shortcuts dialog */
  .kbd-modal .key{display:inline-block;min-width:22px;padding:2px 6px;border-radius:6px;border:1px solid var(--keycap-border);background:var(--keycap-bg);color:var(--keycap-fg);font-weight:600;margin:0 4px 0 0}
  .kbd-grid{display:grid;grid-template-columns:auto 1fr;gap:8px 14px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--toast-bg);color:var(--toast-fg);padding:8px 12px;border-radius:10px;font-size:12px;box-shadow:0 4px 16px rgba(0,0,0,.25);z-index:999}
  .toast button{margin-left:10px;border:none;background:transparent;color:#fff;cursor:pointer;text-decoration:underline}

</style>
</head>
<body class="lavender">
  <h1>MapleStory Dailies</h1>
  <div id="utc-time">UTC Time: --/--/---- --:--:--</div>

  <!-- Theme -->
  <div class="top-bar">
    <label for="theme">Theme:</label>
    <div class="select-wrap">
      <select id="theme">
        <option value="light">Light Mode</option>
        <option value="cloud">Cloud (Light)</option>
        <option value="lavender" selected>Lavender (Light)</option>
        <option value="matcha">Matcha (Light)</option>
        <option value="dark">Dark Mode</option>
        <option value="evergreen">Evergreen (Dark)</option>
      </select>
    </div>
  </div>

  <!-- Instructions -->
  <div id="instructions">
    <button id="instr-toggle" type="button" class="btn">Hide</button>
    <p>Minimal daily tracker. Data stays on your device or in exported files.</p>
    <ol>
      <li>Choose an existing preset or create a new one</li>
      <li>Enter Character Name. Use the Accents button if needed</li>
      <li>Wait a moment for image, job, and level to update or upload an avatar</li>
      <li>Review and check daily tasks. Mark any priorities if available</li>
      <li>Save your changes to the current preset</li>
      <li>Load a different preset or manage presets to rename, duplicate, or delete</li>
    </ol>
  </div>

  <!-- Presets + Shortcuts + Add Character -->
  <div class="toolbar">
    <div class="left"></div>
    <div class="right" id="preset-area">
      <label for="preset">Preset:</label>
      <div class="preset-inline" id="preset-inline">
        <div class="select-wrap">
          <select id="preset" aria-label="Preset selector"></select>
        </div>
        <span id="preset-count" aria-live="polite"></span>

        <!-- New preset -->
        <button id="preset-new-btn" class="icon-btn" title="New preset" aria-label="New preset">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
        </button>

        <!-- Rename (inline) -->
        <button id="preset-rename-btn" class="icon-btn" title="Rename preset" aria-label="Rename preset">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm17.71-10.04a.996.996 0 0 0 0-1.41l-2.5-2.5a.996.996 0 1 0-1.41 1.41l2.5 2.5c.39.39 1.02.39 1.41 0Z"/></svg>
        </button>

        <!-- Menu (Manage presets…) -->
        <button id="preset-menu-btn" class="icon-btn" title="Preset menu" aria-label="Preset menu">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a2 2 0 1 0 0-4a2 2 0 0 0 0 4Zm0 6a2 2 0 1 0 0-4a2 2 0 0 0 0 4Zm0 6a2 2 0 1 0 0-4a2 2 0 0 0 0 4Z"/></svg>
        </button>

        <!-- Shortcuts button -->
        <button id="shortcuts-btn" class="icon-btn" title="Keyboard shortcuts" aria-label="Keyboard shortcuts">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16v12H4zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zM7 13h10v2H7z"/></svg>
        </button>
      </div>

      <!-- Inline rename controls -->
      <div id="preset-rename-wrap" style="display:none; flex-direction:column; gap:4px;">
        <div class="preset-inline">
          <input id="preset-rename-input" type="text" maxlength="12" placeholder="Preset name" aria-label="Preset name">
          <button id="preset-rename-save" class="icon-btn" title="Save">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12L3.41 13.41L9 19l12-12l-1.41-1.41z"/></svg>
          </button>
          <button id="preset-rename-cancel" class="btn secondary" style="padding:4px 8px;">Cancel</button>
        </div>
        <div id="preset-rename-err" class="inline-msg" role="status" aria-live="polite"></div>
      </div>

      <div id="preset-mini-menu" class="mini-menu" role="menu" aria-label="Preset menu">
        <button id="menu-manage" role="menuitem">Manage presets…</button>
      </div>

      <span id="preset-limit-note" class="preset-limit-note" style="display:none;">You have reached the limit of 10 presets. Delete a preset to add a new one.</span>

      <!-- Save / Load -->
      <button id="save-btn" class="icon-btn" title="Save" aria-label="Save">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4ZM5 5h10v4H5V5Zm7 14H6v-6h6v6Z"/></svg>
      </button>
      <button id="load-btn" class="icon-btn" title="Load" aria-label="Load">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14a2 2 0 0 0 2-2v-5h-2v5H5V6h5V4H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Zm7-14v6.17l2.59-2.58L16 11l-4 4l-4-4l1.41-1.41L11 12.17V6h1Z"/></svg>
      </button>
      <input id="import-file" type="file" accept="application/json" hidden>
    </div>

    <!-- Add Character (far right) -->
    <div class="left" style="margin-left:auto;">
      <button id="add-character-btn" class="btn" title="Add Character">+ Add Character</button>
    </div>
  </div>

  <div id="checklists"></div>

  <!-- Confirm Delete Character -->
  <div id="confirm-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="confirm-title" aria-modal="true">
      <h3 id="confirm-title">Confirm Delete</h3>
      <p id="confirm-msg">Delete the character: Untitled?</p>
      <div class="actions">
        <button id="confirm-ok" type="button" class="btn">Yes</button>
        <button id="confirm-cancel" type="button" class="btn secondary">No</button>
      </div>
    </div>
  </div>

  <!-- Manage Presets -->
  <div id="mp-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="mp-title" aria-modal="true">
      <h3 id="mp-title">Manage Presets</h3>
      <div id="mp-list"></div>
      <div class="actions">
        <button id="mp-close" type="button" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Import Replace (when at limit) -->
  <div id="replace-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="rep-title" aria-modal="true">
      <h3 id="rep-title">Replace a preset</h3>
      <p>Import would exceed the limit (10). Choose a preset to replace, or Cancel.</p>
      <div class="preset-inline" style="margin-top:6px">
        <div class="select-wrap">
          <select id="replace-select" aria-label="Choose preset to replace"></select>
        </div>
      </div>
      <div class="actions">
        <button id="replace-ok" type="button" class="btn">Replace</button>
        <button id="replace-cancel" type="button" class="btn secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts dialog -->
  <div id="kbd-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal kbd-modal" role="dialog" aria-labelledby="kbd-title" aria-modal="true">
      <h3 id="kbd-title">Keyboard Shortcuts</h3>
      <div class="kbd-grid" role="list">
        <div><span class="key">↑</span><span class="key">↓</span></div><div>Move between tasks</div>
        <div><span class="key">Enter</span> <span class="key">Space</span></div><div>Toggle the focused task</div>
        <div><span class="key">P</span></div><div>Cycle task priority</div>
        <div><span class="key">Alt</span> + <span class="key">A</span></div><div>Open the Accents panel for the focused field</div>
        <div><span class="key">Esc</span></div><div>Close the Accents panel or Shortcuts panel</div>
        <div><span class="key">Tab</span> / <span class="key">Shift</span>+<span class="key">Tab</span></div><div>Move between controls</div>
        <div><span class="key">?</span></div><div>Open this panel from anywhere</div>
      </div>
      <div class="actions">
        <button id="kbd-close" class="btn">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none;">Press ? to see keyboard shortcuts <button id="toast-dismiss" type="button">Dismiss</button></div>

  <input id="hidden-upload" type="file" accept="image/*" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
  /* ===== Time & Theme ===== */
  function tickUTC(){
    const n=new Date();
    const y=n.getUTCFullYear(), m=String(n.getUTCMonth()+1).padStart(2,'0'), d=String(n.getUTCDate()).padStart(2,'0');
    const hh=String(n.getUTCHours()).padStart(2,'0'), mm=String(n.getUTCMinutes()).padStart(2,'0'), ss=String(n.getUTCSeconds()).padStart(2,'0');
    document.getElementById("utc-time").textContent=`UTC Time: ${m}/${d}/${y} ${hh}:${mm}:${ss}`;
  }
  setInterval(tickUTC,1000); tickUTC();

  const themeSel=document.getElementById("theme");
  document.body.className=localStorage.getItem("mapleTheme")||"lavender";
  themeSel.value=document.body.className;
  themeSel.addEventListener("change",()=>{ document.body.className=themeSel.value; localStorage.setItem("mapleTheme",themeSel.value); });

  /* ===== Presets (cap at 10) ===== */
  const MAX_PRESETS=10;
  const PRESETS_KEY="maplePresets_v1";
  const OLD_SEL_KEY="maplePreset";
  const OLD_DATA=(n)=>`mapleData_v2_preset${n}`;

  const $=s=>document.querySelector(s);

  function uid(){ return "p"+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4); }

  function loadPresetStore(){
    const raw=localStorage.getItem(PRESETS_KEY);
    if(raw){
      try{ const obj=JSON.parse(raw); if(obj && obj.version===1 && Array.isArray(obj.presets)){ return obj; } }catch{}
    }
    // migrate 3-slot model
    const presets=[];
    for(let i=1;i<=3;i++){
      let data=null; try{ const r=localStorage.getItem(OLD_DATA(i)); data=r?JSON.parse(r):null;}catch{}
      presets.push({id:`p${i}`, name:`Preset ${i}`, updatedAt:Date.now(), data:data||{charCount:0}});
    }
    const oldSel=localStorage.getItem(OLD_SEL_KEY); const activeId=oldSel?`p${parseInt(oldSel,10)||1}`:"p1";
    const store={version:1, activeId, presets};
    localStorage.setItem(PRESETS_KEY, JSON.stringify(store));
    return store;
  }
  function savePresetStore(store){ localStorage.setItem(PRESETS_KEY, JSON.stringify(store)); }
  function getActive(store){ return store.presets.find(p=>p.id===store.activeId) || store.presets[0]; }
  function setActive(store,id){ if(store.presets.some(p=>p.id===id)){ store.activeId=id; savePresetStore(store); } }

  function loadData(){ const st=loadPresetStore(); return getActive(st)?.data || {charCount:0}; }
  function saveData(d){ const st=loadPresetStore(); const i=st.presets.findIndex(p=>p.id===st.activeId); if(i>=0){ st.presets[i].data=d; st.presets[i].updatedAt=Date.now(); savePresetStore(st);} }

  const presetSel=$("#preset"), presetCount=$("#preset-count"), presetNewBtn=$("#preset-new-btn"), presetLimitNote=$("#preset-limit-note");
  function refreshPresetDropdown(){
    const st=loadPresetStore(); const activeId=st.activeId;
    presetSel.innerHTML="";
    st.presets.forEach(p=>{ const opt=document.createElement("option"); opt.value=p.id; opt.textContent=p.name; presetSel.appendChild(opt); });
    presetSel.value=activeId;
    presetCount.textContent=`Presets ${st.presets.length} of ${MAX_PRESETS}`;
    const atLimit = st.presets.length>=MAX_PRESETS;
    presetNewBtn.disabled = atLimit;
    presetLimitNote.style.display = atLimit ? "" : "none";
  }
  presetSel.addEventListener("change",()=>{ const id=presetSel.value; const st=loadPresetStore(); setActive(st,id); build(); });

  function validateName(name,store,excludeId){
    const v=(name||"").trim();
    if(!v) return "Enter a name";
    if(v.length>12) return "Limit 12 characters";
    if(/^default$/i.test(v)) return "“Default” cannot be renamed";
    const clash = store.presets.some(p=>p.id!==excludeId && p.name.toLowerCase()===v.toLowerCase());
    if(clash) return "Name already in use";
    return null;
  }

  // New preset
  presetNewBtn.addEventListener("click",()=>{
    const st=loadPresetStore();
    if(st.presets.length>=MAX_PRESETS){ refreshPresetDropdown(); return; }
    const nameBase="New Preset";
    let name=nameBase.slice(0,12), n=1;
    const names=st.presets.map(p=>p.name.toLowerCase());
    while(names.includes(name.toLowerCase())){
      const suffix=String(n++); name=(nameBase.slice(0, Math.max(0,12-suffix.length))+suffix);
    }
    const id=uid();
    st.presets.push({id, name, updatedAt:Date.now(), data:{charCount:0}});
    st.activeId=id; savePresetStore(st);
    refreshPresetDropdown(); build();
  });

  // Inline rename handlers
  const presetRenameBtn=$("#preset-rename-btn"), presetRenameWrap=$("#preset-rename-wrap"), presetInline=$("#preset-inline"),
        renameInput=$("#preset-rename-input"), renameSave=$("#preset-rename-save"), renameCancel=$("#preset-rename-cancel"),
        presetMiniMenu=$("#preset-mini-menu"), presetMenuBtn=$("#preset-menu-btn"), presetArea=$("#preset-area"),
        renameErr=$("#preset-rename-err");
  let renaming=false;
  function openInlineRename(){
    const st=loadPresetStore(), active=getActive(st); if(!active) return;
    const cur=active.name || "";
    if(/^default$/i.test(cur)){ renameErr.textContent="“Default” cannot be renamed."; presetRenameWrap.style.display="block"; presetInline.style.display="none";
      renameInput.value=cur; renameInput.readOnly=true; setTimeout(()=>closeInlineRename(),1200); return; }
    renaming=true; renameErr.textContent=""; presetInline.style.display="none"; presetRenameWrap.style.display="flex";
    renameInput.readOnly=false; renameInput.value=cur; renameInput.setSelectionRange(0,cur.length); renameInput.focus(); renameErr.textContent="Editing preset name…";
  }
  function closeInlineRename(){ renaming=false; presetRenameWrap.style.display="none"; presetInline.style.display="flex"; renameErr.textContent=""; presetSel.focus(); }
  function doRenameInline(){
    const st=loadPresetStore(), active=getActive(st); if(!active) return;
    const err=validateName(renameInput.value, st, active.id); if(err){ renameErr.textContent=err; renameInput.focus(); return; }
    active.name = renameInput.value.trim(); active.updatedAt=Date.now(); savePresetStore(st); refreshPresetDropdown(); closeInlineRename();
  }
  presetRenameBtn.addEventListener("click", openInlineRename);
  renameCancel.addEventListener("click", closeInlineRename);
  renameInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doRenameInline(); } else if(e.key==="Escape"){ e.preventDefault(); closeInlineRename(); }});
  renameSave.addEventListener("click", doRenameInline);
  document.addEventListener("mousedown",(e)=>{ if(!renaming) return; if(!presetRenameWrap.contains(e.target) && !presetInline.contains(e.target)) closeInlineRename(); });

  // Mini menu (Manage presets…)
  function toggleMiniMenu(force){ const show=(force!==undefined)?force:!presetMiniMenu.classList.contains("show"); presetMiniMenu.classList.toggle("show",show); }
  presetMenuBtn.addEventListener("click",(e)=>{ e.stopPropagation(); toggleMiniMenu(); });
  document.addEventListener("click",(e)=>{ if(!presetArea.contains(e.target)) toggleMiniMenu(false); });
  $("#menu-manage").addEventListener("click",()=>{ toggleMiniMenu(false); openManagePresets(); });

  /* ===== Manage Presets modal ===== */
  const mpOverlay=$("#mp-overlay"), mpList=$("#mp-list"), mpClose=$("#mp-close");
  function openManagePresets(){ buildManageList(); mpOverlay.classList.add("show"); mpOverlay.setAttribute("aria-hidden","false"); }
  function closeManagePresets(){ mpOverlay.classList.remove("show"); mpOverlay.setAttribute("aria-hidden","true"); }
  mpClose.addEventListener("click", closeManagePresets);
  mpOverlay.addEventListener("mousedown",(e)=>{ if(e.target===mpOverlay) closeManagePresets(); });

  function buildManageList(){
    const st=loadPresetStore(); mpList.innerHTML="";
    st.presets.forEach(p=>{
      const row=document.createElement("div"); row.className="mp-row";
      const nameEl=document.createElement("div"); nameEl.className="mp-name"; nameEl.textContent=p.name;
      const btnRen=document.createElement("button"); btnRen.className="btn secondary"; btnRen.textContent="Rename";
      const btnDup=document.createElement("button"); btnDup.className="btn secondary"; btnDup.textContent="Duplicate";
      const btnDel=document.createElement("button"); btnDel.className="btn secondary"; btnDel.textContent="Delete";

      btnRen.addEventListener("click",()=>{ // inline edit row
        const input=document.createElement("input"); input.className="mp-input"; input.type="text"; input.maxLength=12; input.value=p.name;
        const err=document.createElement("div"); err.className="mp-err"; err.setAttribute("role","status"); err.setAttribute("aria-live","polite");
        row.innerHTML=""; row.appendChild(input); row.appendChild(btnDup); row.appendChild(btnDel); row.appendChild(err);
        input.focus(); input.setSelectionRange(0,input.value.length);
        function save(){ const eText=validateName(input.value,loadPresetStore(),p.id); if(eText){ err.textContent=eText; input.focus(); return; }
          const st2=loadPresetStore(); const idx=st2.presets.findIndex(x=>x.id===p.id); if(idx>=0){ st2.presets[idx].name=input.value.trim(); st2.presets[idx].updatedAt=Date.now(); savePresetStore(st2); }
          refreshPresetDropdown(); buildManageList(); presetSel.focus(); }
        input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); save(); } else if(e.key==="Escape"){ e.preventDefault(); buildManageList(); }});
        btnDup.onclick=()=>{ duplicatePreset(p.id); buildManageList(); refreshPresetDropdown(); };
        btnDel.onclick=()=>{ deletePreset(p.id); buildManageList(); refreshPresetDropdown(); };
      });

      btnDup.addEventListener("click",()=>{ duplicatePreset(p.id); buildManageList(); refreshPresetDropdown(); });
      btnDel.addEventListener("click",()=>{ deletePreset(p.id); buildManageList(); refreshPresetDropdown(); });

      row.appendChild(nameEl); row.appendChild(btnRen); row.appendChild(btnDup); row.appendChild(btnDel);
      mpList.appendChild(row);
    });
  }

  function duplicatePreset(id){
    const st=loadPresetStore();
    if(st.presets.length>=MAX_PRESETS){ refreshPresetDropdown(); return; }
    const src=st.presets.find(p=>p.id===id); if(!src) return;
    const copyId=uid();
    let base=`Copy of ${src.name}`.slice(0,12), name=base, n=1;
    const names=st.presets.map(p=>p.name.toLowerCase());
    while(names.includes(name.toLowerCase())){ const t=String(n++); name=(base.slice(0, Math.max(0,12-t.length))+t); }
    const data=JSON.parse(JSON.stringify(src.data||{charCount:0}));
    st.presets.push({id:copyId, name, updatedAt:Date.now(), data});
    savePresetStore(st); refreshPresetDropdown(); build();
  }

  function deletePreset(id){
    const st=loadPresetStore();
    if(st.presets.length<=1){ alert("At least one preset is required."); return; }
    const idx=st.presets.findIndex(p=>p.id===id); if(idx<0) return;
    st.presets.splice(idx,1);
    if(st.activeId===id){ st.activeId = st.presets[0].id; }
    savePresetStore(st);
    refreshPresetDropdown(); build();
  }

  /* ===== Save / Load / Import (with replace-at-limit) ===== */
  function todayUTC(){ const n=new Date(); return `${n.getUTCFullYear()}-${String(n.getUTCMonth()+1).padStart(2,'0')}-${String(n.getUTCDate()).padStart(2,'0')}`; }
  function dailyKey(cardIdx,tIdx){ const st=loadPresetStore(); const pid=st.activeId||"p1"; return `check_${todayUTC()}_${pid}_c${cardIdx}_t${tIdx}`; }

  $("#save-btn").addEventListener("click", ()=>{
    const st=loadPresetStore(), active=getActive(st), d=loadData(), chars=[];
    for(let i=0;i<d.charCount;i++){
      const ct=Math.max(1,d[`char_${i}_taskCount`]||1); const tasks=[];
      for(let t=0;t<ct;t++){ tasks.push({text:d[`char_${i}_task_${t}`]||"", done:(localStorage.getItem(dailyKey(i,t))==='true')}); }
      chars.push({name:d[`char_${i}_name`]||"", image:d[`char_${i}_image`]||"", level:d[`char_${i}_level`]||"", job:d[`char_${i}_job`]||"", userImage:!!d[`char_${i}_userImage`], tasks});
    }
    const payload={version:5, presetId: active.id, presetName: active.name, characters:chars};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`maplestory-dailies-${active.name}.json`; document.body.appendChild(a); a.click(); a.remove();
  });

  $("#load-btn").addEventListener("click",()=>$("#import-file").click());
  const replaceOverlay=$("#replace-overlay"), replaceSelect=$("#replace-select"), replaceOk=$("#replace-ok"), replaceCancel=$("#replace-cancel");
  $("#import-file").addEventListener("change",(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      let obj=null; try{ obj=JSON.parse(r.result); }catch{}
      if(!obj || !Array.isArray(obj.characters)){ alert("Invalid file."); return; }
      const st=loadPresetStore();
      const incomingId = (obj.presetId && typeof obj.presetId==="string") ? obj.presetId : null;
      const existingIdx = incomingId ? st.presets.findIndex(p=>p.id===incomingId) : -1;

      // Build data blob
      const chars=obj.characters.slice(0,20); const d={charCount:chars.length};
      for(let i=0;i<chars.length;i++){
        const c=chars[i];
        d[`char_${i}_name`]=c.name||""; d[`char_${i}_image`]=c.image||""; d[`char_${i}_level`]=c.level||""; d[`char_${i}_job`]=c.job||""; d[`char_${i}_userImage`]=!!c.userImage;
        const tc=Math.max(1,Math.min(10,(c.tasks||["",""]).length)); d[`char_${i}_taskCount`]=tc;
        for(let t=0;t<tc;t++){ const task=c.tasks[t]||{}; d[`char_${i}_task_${t}`]=(task.text ?? task) || ""; }
      }

      function applyIntoPresetId(targetId){
        const stNow=loadPresetStore(); const idx=stNow.presets.findIndex(p=>p.id===targetId); if(idx<0) return;
        stNow.presets[idx].data = d; stNow.presets[idx].updatedAt=Date.now(); savePresetStore(stNow);
        // clear today's checks for that preset scope then reapply
        const prevActive=stNow.activeId; stNow.activeId=targetId; savePresetStore(stNow);
        for(let i=0;i<d.charCount;i++){ const ct=d[`char_${i}_taskCount`]||1; for(let t=0;t<ct;t++) localStorage.removeItem(dailyKey(i,t)); }
        for(let i=0;i<chars.length;i++){ const c=chars[i]; const tc=Math.max(1,Math.min(10,(c.tasks||[]).length)); for(let t=0;t<tc;t++){ const task=c.tasks[t]; if(task && task.done===true) localStorage.setItem(dailyKey(i,t),'true'); } }
        const stRestore=loadPresetStore(); stRestore.activeId=prevActive; savePresetStore(stRestore);
        refreshPresetDropdown(); build();
      }

      if(existingIdx>=0){
        // merge into existing preset id (same id)
        applyIntoPresetId(st.presets[existingIdx].id);
      }else{
        // need to add new preset; check limit
        if(st.presets.length>=MAX_PRESETS){
          // open replace modal
          replaceSelect.innerHTML="";
          st.presets.forEach(p=>{ const opt=document.createElement("option"); opt.value=p.id; opt.textContent=p.name; replaceSelect.appendChild(opt); });
          replaceOverlay.classList.add("show"); replaceOverlay.setAttribute("aria-hidden","false");
          replaceOk.onclick=()=>{ replaceOverlay.classList.remove("show"); replaceOverlay.setAttribute("aria-hidden","true"); applyIntoPresetId(replaceSelect.value); };
          replaceCancel.onclick=()=>{ replaceOverlay.classList.remove("show"); replaceOverlay.setAttribute("aria-hidden","true"); };
        }else{
          // add new preset
          const base=(obj.presetName && typeof obj.presetName==="string" && obj.presetName.trim()) ? obj.presetName.trim().slice(0,12) : "Imported";
          const names=st.presets.map(p=>p.name.toLowerCase()); let name=base, n=1;
          while(names.includes(name.toLowerCase())){ const s=String(n++); name=(base.slice(0, Math.max(0,12-s.length))+s); }
          const id=incomingId || uid();
          st.presets.push({id, name, updatedAt:Date.now(), data:d}); savePresetStore(st); refreshPresetDropdown(); build();
        }
      }
    }; r.readAsText(f); e.target.value="";
  });

  /* ===== App — Characters / Tasks (same behavior as prior build) ===== */
  const WORKER_URL = "https://ms-avatar-proxy.meehoowee.workers.dev/mapleranks";
  const BASE_MODEL_URL = "https://maplestory.io/api/character/%7B%22itemId%22%3A2000%2C%22version%22%3A%22250%22%7D%2C%7B%22itemId%22%3A12000%2C%22version%22%3A%22250%22%7D/stand1/0?showears=false&showLefEars=false&showHighLefEars=undefined&resize=1&name=&flipX=undefined";
  const MAX_CHARACTERS=20, MAX_TASKS=10;

  const checklists=$("#checklists");

  function metaText(level,job){ const parts=[]; if(level) parts.push(`Lv. ${level}`); if(job) parts.push(job); return parts.join(" "); }

  function build(){
    refreshPresetDropdown();
    checklists.innerHTML="";
    const d=loadData();
    for(let i=0;i<d.charCount;i++){ checklists.appendChild(buildCard(i,d)); }
    initCardSortable();
  }

  function buildCard(i,d){
    const card=document.createElement("div"); card.className="character"; card.dataset.index=i;

    // top-left: move arrows
    const left=document.createElement("div"); left.className="window-controls-left";
    left.append(iconBtn("Move Up",arrowUpSVG(),()=>moveCard(i,i-1)), iconBtn("Move Down",arrowDownSVG(),()=>moveCard(i,i+1)));
    card.appendChild(left);

    // top-right: upload / duplicate / delete
    const right=document.createElement("div"); right.className="window-controls-right";
    right.append(iconBtn("Upload Avatar",uploadSVG(),()=>startUploadFor(i)), iconBtn("Duplicate",duplicateSVG(),()=>duplicateCharacter(i)), iconBtn("Delete","&times;",()=>confirmDelete(i)));
    card.appendChild(right);

    // drag handle (invisible, above image)
    const dragHandle=document.createElement("div"); dragHandle.className="card-drag-handle"; card.appendChild(dragHandle);

    // image
    const imgWrap=document.createElement("div"); imgWrap.className="char-image-wrap";
    const imgSrc=(d[`char_${i}_image`]||"")||BASE_MODEL_URL;
    imgWrap.innerHTML=`<img loading="lazy" decoding="async" alt="Character image" src="${imgSrc}">`;
    card.appendChild(imgWrap);

    // meta (level/job) + inline status
    const meta=document.createElement("div"); meta.className="char-meta"; meta.textContent=metaText(d[`char_${i}_level`], d[`char_${i}_job`]); card.appendChild(meta);
    const msg=document.createElement("div"); msg.className="inline-msg"; msg.setAttribute("role","status"); msg.setAttribute("aria-live","polite"); card.appendChild(msg);

    // name + accents button
    const nameRow=document.createElement("div"); nameRow.className="name-row";
    const name=document.createElement("input"); name.className="char-name"; name.placeholder="Character Name"; name.value=d[`char_${i}_name`]||"";
    name.addEventListener("input",()=>{ const dd=loadData(); dd[`char_${i}_name`]=name.value; saveData(dd); scheduleLookup(i,name,meta,msg,imgWrap.querySelector("img")); });
    name.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); triggerLookup(i,name,meta,msg,imgWrap.querySelector("img")); }});
    name.addEventListener("blur",()=>{ triggerLookup(i,name,meta,msg,imgWrap.querySelector("img")); });
    const accBtn=document.createElement("button"); accBtn.className="icon-btn"; accBtn.title="Accents"; accBtn.setAttribute("aria-label","Accents");
    accBtn.innerHTML='<span style="font-weight:700;">Â</span>';
    accBtn.addEventListener("mousedown",(e)=>e.preventDefault());
    accBtn.addEventListener("click",()=>{/* your accents panel hook here if present */});
    nameRow.append(name,accBtn); card.appendChild(nameRow);

    // tasks
    const tasksWrap=document.createElement("div"); tasksWrap.className="tasks";
    let count=d[`char_${i}_taskCount`]; if(count==null) count=2; if(count<1) count=1; d[`char_${i}_taskCount`]=count; saveData(d);
    for(let t=0;t<count;t++) tasksWrap.appendChild(buildTask(i,t,d));
    card.appendChild(tasksWrap);

    // Check All (bottom)
    const checkRow=document.createElement("div"); checkRow.className="check-all";
    const checkAll=document.createElement("input"); checkAll.type="checkbox";
    const checkLbl=document.createElement("label"); checkLbl.textContent="Check All";
    checkRow.append(checkAll,checkLbl); card.appendChild(checkRow);
    function refreshMaster(){ const boxes=Array.from(tasksWrap.querySelectorAll('.task input[type="checkbox"]')); checkAll.checked=boxes.length>0 && boxes.every(b=>b.checked); }
    checkAll.addEventListener("change",()=>{ const boxes=Array.from(tasksWrap.querySelectorAll('.task input[type="checkbox"]')); boxes.forEach(b=>{ const tIdx=+b.dataset.idx; b.checked=checkAll.checked; localStorage.setItem(dailyKey(i,tIdx), checkAll.checked?'true':'false'); }); });
    setTimeout(refreshMaster,0);

    attachTaskSortable(tasksWrap,i);
    attachNameLookup(i,name,meta,msg,imgWrap.querySelector("img"));
    return card;
  }

  function buildTask(i,t,d){
    const row=document.createElement("div"); row.className="task"; row.dataset.idx=t;
    const box=document.createElement("input"); box.type="checkbox"; box.dataset.idx=t; box.checked=(localStorage.getItem(dailyKey(i,t))==='true');
    box.onchange=()=> localStorage.setItem(dailyKey(i,t), box.checked?'true':'false');

    const input=document.createElement("input"); input.type="text"; input.placeholder="Daily Task"; input.value=d[`char_${i}_task_${t}`]||"";
    const del=document.createElement("button"); del.className="task-delete"; del.title="Delete Task"; del.textContent="×";
    const handle=document.createElement("div"); handle.className="handle"; handle.textContent="⋮⋮";

    input.addEventListener("keydown",(e)=>{
      if(e.key==="ArrowUp"){ e.preventDefault(); moveFocus(i,t,-1); }
      else if(e.key==="ArrowDown"){ e.preventDefault(); moveFocus(i,t,+1); }
      else if(e.key==="Enter" || e.key===" "){ e.preventDefault(); box.checked=!box.checked; box.dispatchEvent(new Event('change',{bubbles:true})); }
      else if(e.key==="Tab" && !e.shiftKey){ e.preventDefault(); insertTaskAfter(i,t); setTimeout(()=>focusNewTaskInput(i,t+1),0); }
      else if(e.key.toLowerCase()==="p"){ // priority key reserved (UI not shown in this snippet)
        // (No-op here; priority feature exists in your full build)
      }
    });
    box.addEventListener("keydown",(e)=>{
      if(e.key===" "||e.key==="Enter"){ e.preventDefault(); box.checked=!box.checked; box.dispatchEvent(new Event('change',{bubbles:true})); }
      else if(e.key==="ArrowUp"){ e.preventDefault(); moveFocus(i,t,-1); }
      else if(e.key==="ArrowDown"){ e.preventDefault(); moveFocus(i,t,+1); }
    });

    input.addEventListener("input",()=>{
      const dd=loadData();
      if(input.value===""){
        const ct=dd[`char_${i}_taskCount`]||1;
        if(ct>1){ shiftDeleteTask(i,t,ct,dd); } else { dd[`char_${i}_task_${t}`]=""; saveData(dd); }
    } else { dd[`char_${i}_task_${t}`]=input.value; saveData(dd); }
    });

    del.onclick=()=>{ const dd=loadData(); const ct=dd[`char_${i}_taskCount`]||1;
      if(ct>1){ shiftDeleteTask(i,t,ct,dd); } else { input.value=""; dd[`char_${i}_task_${t}`]=""; saveData(dd); }
      build();
    };

    row.append(box,input,del,handle);
    return row;
  }

  function focusNewTaskInput(i,tNew){
    const card=document.querySelector(`#checklists .character[data-index="${i}"]`);
    const inputs=Array.from(card.querySelectorAll('.tasks .task input[type="text"]'));
    (inputs[tNew]||inputs[inputs.length-1])?.focus();
  }
  function moveFocus(cardIndex,currentIdx,dir){
    const d=loadData(); const ct=Math.max(1,d[`char_${cardIndex}_taskCount`]||1);
    const next=Math.max(0,Math.min(ct-1,currentIdx+dir)); const card=document.querySelector(`#checklists .character[data-index="${cardIndex}"]`);
    const inputs=Array.from(card.querySelectorAll('.tasks .task input[type="text"]')); (inputs[next]||inputs[0])?.focus();
  }
  function insertTaskAfter(i,t){
    const d=loadData(); const ct=Math.max(1,d[`char_${i}_taskCount`]||1); if(ct>=MAX_TASKS) return;
    for(let k=ct-1;k>t;k--) d[`char_${i}_task_${k+1}`]=d[`char_${i}_task_${k}`]||"";
    d[`char_${i}_task_${t+1}`]=""; d[`char_${i}_taskCount`]=ct+1;
    for(let k=ct-1;k>t;k--){ const from=localStorage.getItem(dailyKey(i,k)); if(from!==null) localStorage.setItem(dailyKey(i,k+1),from); localStorage.removeItem(dailyKey(i,k)); }
    localStorage.removeItem(dailyKey(i,t+1)); saveData(d); build();
  }
  function shiftDeleteTask(i,t,ct,dd){
    dd[`char_${i}_task_${t}`]="";
    for(let k=t+1;k<ct;k++){ dd[`char_${i}_task_${k-1}`]=dd[`char_${i}_task_${k}`]||""; const from=localStorage.getItem(dailyKey(i,k)); if(from!==null) localStorage.setItem(dailyKey(i,k-1),from); localStorage.removeItem(dailyKey(i,k)); }
    delete dd[`char_${i}_task_${ct-1}`]; localStorage.removeItem(dailyKey(i,ct-1)); dd[`char_${i}_taskCount`]=ct-1; saveData(dd); build();
  }

  function attachTaskSortable(tasksWrap,cardIndex){
    if(tasksWrap._sortable){ tasksWrap._sortable.destroy(); tasksWrap._sortable=null; }
    tasksWrap._sortable = Sortable.create(tasksWrap,{
      animation:160, handle:".handle", draggable:".task", ghostClass:"dragging",
      onEnd:()=>{
        const d=loadData(); const ct=d[`char_${cardIndex}_taskCount`]||1;
        const texts=[], checks=[];
        for(let t=0;t<ct;t++){ texts.push(d[`char_${cardIndex}_task_${t}`]||""); checks.push(localStorage.getItem(dailyKey(cardIndex,t))==='true'); }
        const order=Array.from(tasksWrap.querySelectorAll(".task")).map(r=>+r.dataset.idx);
        for(let p=0;p<order.length;p++){ const tOld=order[p]; d[`char_${cardIndex}_task_${p}`]=texts[tOld]||""; }
        for(let t=0;t<ct;t++) localStorage.removeItem(dailyKey(cardIndex,t));
        for(let p=0;p<order.length;p++){ const tOld=order[p]; if(checks[tOld]) localStorage.setItem(dailyKey(cardIndex,p),'true'); }
        saveData(d); build();
      }
    });
  }

  // Cards reorder
  let sortableCards=null;
  function initCardSortable(){
    if(sortableCards){ sortableCards.destroy(); sortableCards=null; }
    sortableCards=new Sortable(checklists,{ animation:180, ghostClass:"dragging", draggable:".character", handle:".card-drag-handle",
      onEnd:(evt)=>{ const from=evt.oldIndex,to=evt.newIndex; if(from==null||to==null||from===to) return; moveCard(from,to); }
    });
  }
  function moveCard(from,to){
    const cont=checklists; const n=[...cont.querySelectorAll(".character")].length; if(from<0||from>=n) return; to=Math.max(0,Math.min(n-1,to)); if(from===to) return;
    const d=loadData(), list=[];
    for(let i=0;i<d.charCount;i++){
      const ct=Math.max(1,d[`char_${i}_taskCount`]||1); const tasks=[]; for(let t=0;t<ct;t++) tasks.push(d[`char_${i}_task_${t}`]||"");
      list.push({name:d[`char_${i}_name`]||"", image:d[`char_${i}_image`]||"", level:d[`char_${i}_level`]||"", job:d[`char_${i}_job`]||"", userImage:!!d[`char_${i}_userImage`], tasks});
    }
    const checks=list.map((c,idx)=>{ const a=[]; for(let t=0;t<c.tasks.length;t++) a.push(localStorage.getItem(dailyKey(idx,t))==='true'); return a; });
    const moved=list.splice(from,1)[0], movedChecks=checks.splice(from,1)[0]; list.splice(to,0,moved); checks.splice(to,0,movedChecks);
    const nd={charCount:list.length};
    for(let i=0;i<list.length;i++){ const c=list[i]; nd[`char_${i}_name`]=c.name; nd[`char_${i}_image`]=c.image; nd[`char_${i}_level`]=c.level; nd[`char_${i}_job`]=c.job; nd[`char_${i}_userImage`]=!!c.userImage; const tc=Math.max(1,Math.min(10,c.tasks.length)); nd[`char_${i}_taskCount`]=tc; for(let t=0;t<tc;t++) nd[`char_${i}_task_${t}`]=c.tasks[t]||""; }
    for(let i=0;i<checks.length;i++){ for(let t=0;t<10;t++) localStorage.removeItem(dailyKey(i,t)); for(let t=0;t<checks[i].length;t++) if(checks[i][t]) localStorage.setItem(dailyKey(i,t),'true'); }
    saveData(nd); build();
  }

  // Add / duplicate / delete character
  $("#add-character-btn").addEventListener("click",()=>{
    const d=loadData(); if(d.charCount>=MAX_CHARACTERS) return alert("Maximum of 20 characters reached.");
    const i=d.charCount; d.charCount=i+1; d[`char_${i}_name`]=""; d[`char_${i}_image`]=""; d[`char_${i}_level`]=""; d[`char_${i}_job`]=""; d[`char_${i}_userImage`]=false;
    d[`char_${i}_taskCount`]=2; d[`char_${i}_task_0`]=""; d[`char_${i}_task_1`]=""; saveData(d); build();
  });
  function duplicateCharacter(i){
    const d=loadData(); if(d.charCount>=MAX_CHARACTERS) return alert("Maximum of 20 characters reached.");
    const ct=d[`char_${i}_taskCount`]||2; const tasks=[]; for(let t=0;t<ct;t++) tasks.push(d[`char_${i}_task_${t}`]||"");
    const ins=d.charCount; d.charCount=ins+1;
    d[`char_${ins}_name`]=d[`char_${i}_name`]||""; d[`char_${ins}_image`]=d[`char_${i}_image`]||""; d[`char_${ins}_level`]=d[`char_${i}_level`]||""; d[`char_${ins}_job`]=d[`char_${i}_job`]||""; d[`char_${ins}_userImage`]=!!d[`char_${i}_userImage`];
    d[`char_${ins}_taskCount`]=ct; for(let t=0;t<ct;t++) d[`char_${ins}_task_${t}`]=tasks[t]||""; saveData(d); build();
  }
  function confirmDelete(i){
    const d=loadData(); const nm=d[`char_${i}_name`]||"Untitled";
    $("#confirm-msg").textContent=`Delete the character: ${nm}?`;
    const overlay=$("#confirm-overlay");
    overlay.classList.add("show"); overlay.setAttribute("aria-hidden","false");
    $("#confirm-ok").onclick=()=>{ overlay.classList.remove("show"); overlay.setAttribute("aria-hidden","true"); doDelete(i); };
    $("#confirm-cancel").onclick=()=>{ overlay.classList.remove("show"); overlay.setAttribute("aria-hidden","true"); };
  }
  function doDelete(i){
    const d=loadData(); const n=d.charCount; if(n<=0) return;
    const ctDel=d[`char_${i}_taskCount`]||0; for(let t=0;t<ctDel;t++) localStorage.removeItem(dailyKey(i,t));
    for(let k=i;k<n-1;k++){
      const ctNext=d[`char_${k+1}_taskCount`]||0;
      for(let t=0;t<ctNext;t++){ const from=localStorage.getItem(dailyKey(k+1,t)); const toKey=dailyKey(k,t); if(from!==null) localStorage.setItem(toKey,from); localStorage.removeItem(dailyKey(k+1,t)); }
      d[`char_${k}_name`]=d[`char_${k+1}_name`]||""; d[`char_${k}_image`]=d[`char_${k+1}_image`]||""; d[`char_${k}_level`]=d[`char_${k+1}_level`]||""; d[`char_${k}_job`]=d[`char_${k+1}_job`]||""; d[`char_${k}_userImage`]=!!d[`char_${k+1}_userImage`];
      const ct=d[`char_${k+1}_taskCount`]||1; d[`char_${k}_taskCount`]=ct; for(let t=0;t<ct;t++) d[`char_${k}_task_${t}`]=d[`char_${k+1}_task_${t}`]||"";
    }
    const last=n-1; const lastCt=d[`char_${last}_taskCount`]||0; for(let t=0;t<lastCt;t++) localStorage.removeItem(dailyKey(last,t));
    delete d[`char_${last}_name`]; delete d[`char_${last}_image`]; delete d[`char_${last}_level`]; delete d[`char_${last}_job`]; delete d[`char_${last}_userImage`];
    delete d[`char_${last}_taskCount`]; for(let t=0;t<lastCt;t++) delete d[`char_${last}_task_${t}`];
    d.charCount=Math.max(0,n-1); saveData(d); build();
  }

  /* ===== Maple Ranks lookup (debounced, cancellable) ===== */
  const MIN_LOOKUP_LEN=4, DEBOUNCE_MS=500;
  const nameTimers=new Map(), nameControllers=new Map(), nameCache=new Map();
  function cacheGet(key){ const v=nameCache.get(key); if(!v) return null; if(Date.now()-v.ts>5*60*1000){ nameCache.delete(key); return null; } return v.data; }
  function cacheSet(key,data){ nameCache.set(key,{ts:Date.now(),data}); }

  function attachNameLookup(cardIndex,nameInput,metaElem,msgElem,imgElem){
    // debounce on input is already wired in buildCard -> scheduleLookup
  }
  function scheduleLookup(cardIndex,nameInput,metaElem,msgElem,imgElem){
    clearTimeout(nameTimers.get(cardIndex));
    const q=nameInput.value.trim(); if(q.length<MIN_LOOKUP_LEN){ nameTimers.set(cardIndex,null); return; }
    nameTimers.set(cardIndex, setTimeout(()=>doLookup(cardIndex,q,nameInput,metaElem,msgElem,imgElem), DEBOUNCE_MS));
  }
  function triggerLookup(cardIndex,nameInput,metaElem,msgElem,imgElem){
    clearTimeout(nameTimers.get(cardIndex));
    const q=nameInput.value.trim(); if(q.length<MIN_LOOKUP_LEN) return;
    doLookup(cardIndex,q,nameInput,metaElem,msgElem,imgElem);
  }
  async function doLookup(cardIndex,query,nameInput,metaElem,msgElem,imgElem){
    const prev=nameControllers.get(cardIndex); if(prev){ try{ prev.abort(); }catch{} }
    const cacheKey=query.toLowerCase(); const cached=cacheGet(cacheKey);
    if(cached){ if(!cached || cached.ok===false){ renderNotFoundIfCurrent(cardIndex,query,nameInput,metaElem,msgElem); return; } applyLookupResult(cardIndex,query,nameInput,metaElem,msgElem,imgElem,cached,true); return; }
    const controller=new AbortController(); nameControllers.set(cardIndex,controller);
    try{
      msgElem.style.display=""; msgElem.style.color=getComputedStyle(document.body).getPropertyValue('--meta-fg')||"#6b7280"; msgElem.textContent="Searching…";
      const res=await fetch(`${WORKER_URL}?name=${encodeURIComponent(query)}`,{signal:controller.signal,headers:{accept:"application/json"}});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data=await res.json(); const noMatch=!data || data.ok!==true || (!data.job && !data.level && !data.avatar);
      cacheSet(cacheKey, noMatch? {ok:false}: data);
      if(noMatch){ renderNotFoundIfCurrent(cardIndex,query,nameInput,metaElem,msgElem); return; }
      applyLookupResult(cardIndex,query,nameInput,metaElem,msgElem,imgElem,data,false);
    }catch(err){ if(err?.name!=="AbortError") renderNotFoundIfCurrent(cardIndex,query,nameInput,metaElem,msgElem);
    }finally{ nameControllers.delete(cardIndex); }
  }
  function renderNotFoundIfCurrent(cardIndex, requestQuery, nameInput, metaElem, msgElem){
    const current=nameInput.value.trim(); if(current.toLowerCase()!==requestQuery.toLowerCase()) return;
    metaElem.textContent="Character not found on MapleRanks";
    metaElem.style.color=getComputedStyle(document.documentElement).getPropertyValue('--danger')||"#E57373";
    msgElem.style.display=""; msgElem.style.color=getComputedStyle(document.documentElement).getPropertyValue('--danger')||"#E57373";
    msgElem.textContent="Character not found on MapleRanks";
    setTimeout(()=>{ msgElem.style.display="none"; msgElem.textContent=""; }, 2200);
  }
  function applyLookupResult(cardIndex, requestQuery, nameInput, metaElem, msgElem, imgElem, data, fromCache){
    const current=nameInput.value.trim(); if(current.length<MIN_LOOKUP_LEN || current.toLowerCase()!==requestQuery.toLowerCase()) return;
    metaElem.style.color="";
    if(data.name && data.name.trim() && data.name.trim()!==current){
      msgElem.style.display=""; msgElem.style.color=getComputedStyle(document.body).getPropertyValue('--meta-fg')||"#6b7280"; msgElem.textContent=`Suggestion: ${data.name}`;
      setTimeout(()=>{ msgElem.style.display="none"; msgElem.textContent=""; }, 2200);
    }else{ msgElem.style.display="none"; msgElem.textContent=""; }
    const d=loadData();
    d[`char_${cardIndex}_name`]=current;
    d[`char_${cardIndex}_level`]=data.level || d[`char_${cardIndex}_level`] || "";
    d[`char_${cardIndex}_job`]=data.job || d[`char_${cardIndex}_job`] || "";
    const userHasUpload=!!d[`char_${cardIndex}_userImage`];
    if(!userHasUpload && data.avatar){ d[`char_${cardIndex}_image`]=data.avatar; }
    saveData(d);
    metaElem.textContent=metaText(d[`char_${cardIndex}_level`], d[`char_${cardIndex}_job`]);
    const newSrc=(d[`char_${cardIndex}_image`]||"")||BASE_MODEL_URL;
    if(imgElem && imgElem.src!==newSrc){
      const old=imgElem.src; imgElem.loading="lazy"; imgElem.decoding="async"; imgElem.alt=`Avatar for ${current||"character"}`;
      imgElem.onerror=()=>{ imgElem.onerror=null; imgElem.src=old; msgElem.style.display=""; msgElem.style.color=getComputedStyle(document.documentElement).getPropertyValue('--danger')||"#E57373"; msgElem.textContent="Image failed to load."; setTimeout(()=>{ msgElem.style.display="none"; msgElem.textContent=""; }, 1500); };
      imgElem.src=newSrc;
    }
  }

  // Upload avatar
  function startUploadFor(cardIndex){
    const inp=$("#hidden-upload"); inp.value="";
    inp.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return;
      const url=URL.createObjectURL(f);
      const d=loadData(); d[`char_${cardIndex}_image`]=url; d[`char_${cardIndex}_userImage`]=true; saveData(d); build();
    };
    inp.click();
  }

  // Icons
  function iconBtn(title,svgOrHtml,onClick){ const b=document.createElement("button"); b.className="icon-btn small"; b.title=title; b.innerHTML=svgOrHtml; b.onclick=onClick; return b; }
  function uploadSVG(){ return '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14a2 2 0 0 0 2-2v-5h-2v5H5V6h5V4H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Zm7-14l4 4h-3v4h-2v-4H8l4-4Z"/></svg>'; }
  function duplicateSVG(){ return '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H6a2 2 0 0 0-2 2v10h2V3h10V1zm-4 4h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H12a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm0 2v10h8V7h-8z"/></svg>'; }
  function arrowUpSVG(){ return '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 14l5-5l5 5H7z"/></svg>'; }
  function arrowDownSVG(){ return '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5l5-5H7z"/></svg>'; }

  /* ===== Instructions toggle ===== */
  (function(){ const instr=$("#instructions"), btn=$("#instr-toggle");
    function set(min){ instr.classList.toggle("minimized",min); btn.textContent=min?"Unhide":"Hide"; localStorage.setItem("mapleInstrMin",min?"1":"0"); }
    btn.onclick=()=>set(!instr.classList.contains("minimized")); set(localStorage.getItem("mapleInstrMin")==="1");
  })();

  /* ===== Keyboard Shortcuts panel ===== */
  const kbdOverlay=$("#kbd-overlay"), kbdClose=$("#kbd-close"), shortcutsBtn=$("#shortcuts-btn"), toast=$("#toast"), toastDismiss=$("#toast-dismiss");
  let lastFocusEl=null;
  function openShortcuts(fromBtn){
    lastFocusEl = document.activeElement;
    kbdOverlay.classList.add("show"); kbdOverlay.setAttribute("aria-hidden","false");
    kbdClose.focus();
    // mark hint seen
    localStorage.setItem("shortcutsHintSeen","1"); toast.style.display="none";
    // focus trap
    function trap(e){
      if(e.key==="Escape"){ closeShortcuts(); }
      if(e.key==="Tab"){
        const focusables=[...kbdOverlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')].filter(el=>!el.hasAttribute('disabled'));
        if(!focusables.length) return;
        const first=focusables[0], last=focusables[focusables.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
    }
    kbdOverlay._trap = trap;
    document.addEventListener("keydown", trap);
  }
  function closeShortcuts(){
    kbdOverlay.classList.remove("show"); kbdOverlay.setAttribute("aria-hidden","true");
    document.removeEventListener("keydown", kbdOverlay._trap || (()=>{}));
    if(lastFocusEl && typeof lastFocusEl.focus==="function") lastFocusEl.focus();
  }
  shortcutsBtn.addEventListener("click",()=>{ if(kbdOverlay.classList.contains("show")) closeShortcuts(); else openShortcuts(true); });
  kbdClose.addEventListener("click", closeShortcuts);
  kbdOverlay.addEventListener("mousedown",(e)=>{ if(e.target===kbdOverlay) closeShortcuts(); });

  // Global '?' to open
  document.addEventListener("keydown",(e)=>{
    const isText = /^(INPUT|TEXTAREA)$/.test(e.target.tagName) || e.target.isContentEditable;
    if(e.key === '?' || (e.shiftKey && e.key==='/')){
      e.preventDefault(); // prevent typing '?'
      if(kbdOverlay.classList.contains("show")) closeShortcuts(); else openShortcuts(false);
    }
  });
  // First-time toast
  if(localStorage.getItem("shortcutsHintSeen")!=="1"){ toast.style.display="block"; }
  toastDismiss.addEventListener("click", ()=>{ toast.style.display="none"; localStorage.setItem("shortcutsHintSeen","1"); });

  /* ===== Boot ===== */
  refreshPresetDropdown();
  build();
  </script>
</body>
</html>

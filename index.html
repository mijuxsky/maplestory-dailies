<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maple Dailies</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #111317;
      --muted: #8f9ba8;
      --text: #e8ecf1;
      --text-weak: #cdd6df;
      --soft-red: #e57373;
      --accent: #7aa2f7;
      --accent-weak: rgba(122,162,247,0.15);
      --border: #232833;
      --focus: #98c379;
      --card: #0f1216;
      --ok: #7bd88f;
    }

    /* Light theme */
    .theme-light {
      --bg: #f6f7f9;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --text-weak: #334155;
      --soft-red: #d26464;
      --accent: #2563eb;
      --accent-weak: rgba(37,99,235,0.12);
      --border: #e5e7eb;
      --focus: #059669;
      --card: #ffffff;
      --ok: #22c55e;
    }

    /* Nightshade (dark purple) theme */
    .theme-nightshade {
      --bg: #0a0710;           /* near-black plum */
      --panel: #120e19;        /* deep eggplant */
      --card: #0f0a16;         /* dark grape */
      --border: #2a2037;       /* muted violet border */
      --text: #ece7f5;         /* very light lavender text */
      --text-weak: #c9bfe0;    /* muted lavender */
      --muted: #a496c2;        /* desaturated purple */
      --accent: #9d7cff;       /* bright amethyst */
      --accent-weak: rgba(157,124,255,0.16);
      --soft-red: #e78284;     /* error */
      --focus: #7bd88f;        /* focus ring */
      --ok: #7bd88f;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px; position: relative; }

    /* Header */
    .header { display: flex; align-items: center; gap: 12px; justify-content: space-between; }
    .brand { font-size: 18px; font-weight: 700; }
    .utc-time { font-variant-numeric: tabular-nums; color: var(--muted); }

    /* Global "?" shortcuts button (top-right) */
    .qs-btn { position: fixed; top: 12px; right: 12px; z-index: 200; border: 1px solid var(--border); background: var(--panel); color: var(--text); width: 36px; height: 36px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
    .qs-btn:hover { background: rgba(255,255,255,0.05); }
    .qs-btn:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); }

    /* Shortcuts panel */
    .shortcuts-panel { position: fixed; top: 56px; right: 12px; z-index: 210; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; width: 260px; box-shadow: 0 12px 32px rgba(0,0,0,.35); }
    .shortcuts-panel h4 { margin: 0 0 8px; font-size: 14px; color: var(--text-weak); }
    .shortcuts-panel ul { margin: 0; padding-left: 16px; }

    /* Theme row under UTC */
    .theme-row { margin: 10px 0 16px; display: flex; align-items: center; gap: 10px; }
    .theme-row label { color: var(--text-weak); }
    select, input[type="text"], input[type="number"], textarea { 
      background: var(--panel); color: var(--text); border: 1px solid var(--border); 
      border-radius: 8px; padding: 8px 10px; outline: none; transition: box-shadow .15s ease; 
    }
    /* Keep strong focus visuals for inputs and textarea, but remove special focus border/glow from selects per request */
    input:focus, textarea:focus { box-shadow: 0 0 0 3px var(--accent-weak), 0 0 0 1px var(--accent) inset; }
    select:focus, select:focus-visible, select:active { outline: none; box-shadow: none; }

    /* Toolbar */
    .toolbar { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0 16px; }
    .preset-group { display: inline-flex; gap: 8px; align-items: center; background: var(--panel); padding: 8px; border: 1px solid var(--border); border-radius: 12px; }
    .preset-name { min-width: 190px; }
    .icon-btn { appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 8px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .icon-btn:hover { background: rgba(255,255,255,0.04); }
    .icon-btn:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); }
    .btn { appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    .btn:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); }
    .toolbar-right { justify-self: end; }

    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row.stretch { align-items: stretch; }
    .grow { flex: 1; }
    .muted { color: var(--muted); }

    .avatar { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; background: #000; border: 1px solid var(--border); }
    .avatar-col { display: flex; flex-direction: column; gap: 6px; align-items: center; }
    .upload { display: inline-block; }

    .name-input-wrap { position: relative; display: flex; align-items: center; gap: 6px; }
    .accents-btn { border: 1px solid var(--border); background: var(--panel); color: var(--text); border-radius: 10px; width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
    .accents-btn:hover { background: rgba(255,255,255,0.04); }
    .accents-btn:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); }
    .accents-btn .glyph { font-weight: 700; }

    .meta { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 6px; }
    .meta .pill { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 6px 8px; min-height: 34px; display: flex; align-items: center; }
    .pill .label { color: var(--muted); margin-right: 6px; }

    /* Tasks */
    .tasks { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 8px; }
    .task-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 4px; }
    .task-item { display: grid; grid-template-columns: 20px 1fr; align-items: center; padding: 6px 8px; border-radius: 8px; outline: none; }
    /* Selected line border removed (kept focus style) */
    .task-item.selected { border: none !important; }
    .task-item:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); }
    .task-item .task-text { user-select: none; }

    .howto { margin-top: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .howto h3 { margin: 0 0 8px; font-size: 14px; color: var(--text-weak); }
    .howto ul { margin: 6px 0 0 18px; }

    /* Accents panel */
    .accents-panel { position: absolute; z-index: 20; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.3); width: max-content; }
    .accents-grid { display: grid; grid-template-columns: repeat(8, minmax(22px,auto)); gap: 6px; align-items: center; }
    .accents-char, .accents-base { border: 1px solid var(--border); background: var(--card); padding: 6px 8px; border-radius: 8px; cursor: pointer; text-align: center; min-width: 28px; }
    .accents-char:hover, .accents-base:hover { background: rgba(255,255,255,0.06); }
    .accents-char:focus-visible, .accents-base:focus-visible { box-shadow: 0 0 0 3px var(--accent-weak); outline: none; }
    .accents-variants { display: none; grid-column: 1/-1; }
    .accents-variants.open { display: grid; grid-template-columns: repeat(10, minmax(22px,auto)); gap: 6px; margin-top: 4px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }

    .soft-red { color: var(--soft-red); }

    /* Toast */
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; box-shadow: 0 10px 30px rgba(0,0,0,.4); display: none; z-index: 100; }

    /* Typography alignment for accents UI and How to Use */
    .accents-panel, .howto { font-family: inherit; font-weight: 500; letter-spacing: .01em; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="theme-light">
  <!-- Top-right keyboard shortcuts button -->
  <button id="shortcutsBtn" class="qs-btn" title="Keyboard shortcuts" aria-label="Keyboard shortcuts">?</button>
  <div id="shortcutsPanel" class="shortcuts-panel" role="dialog" aria-modal="true" hidden>
    <h4>Keyboard Shortcuts</h4>
    <ul>
      <li>Up / Down – Move between tasks</li>
      <li>Tab – Toggle the checkbox on the focused task</li>
      <li>Space – Toggle the checkbox on the focused task</li>
      <li>Enter – Add a new task line</li>
      <li>Alt + A – Open Accents for the focused field</li>
      <li>Esc – Close this panel or Accents</li>
    </ul>
  </div>

  <div class="container">
    <div class="header">
      <div class="brand">Maple Dailies</div>
      <div class="utc-time" id="utcTime" aria-live="polite">UTC — --:--:--</div>
    </div>

    <div class="theme-row">
      <label for="themeSelect">Theme:</label>
      <select id="themeSelect" aria-label="Theme selector">
        <option value="theme-light">Light</option>
        <option value="">Dark</option>
        <option value="theme-nightshade">Nightshade (dark)</option>
      </select>
    </div>

    <div class="toolbar">
      <div class="preset-group" role="group" aria-label="Presets">
        <select id="presetSelect" class="preset-name" aria-label="Preset selector"></select>
        <button id="renamePreset" class="icon-btn" title="Rename preset" aria-label="Rename preset">
          <!-- pencil icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
        </button>
        <button id="savePreset" class="icon-btn" title="Save" aria-label="Save">
          <!-- save icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        </button>
        <button id="loadPreset" class="icon-btn" title="Load" aria-label="Load">
          <!-- tray download icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
      </div>

      <div class="toolbar-right">
        <button id="addCharacter" class="btn">+ Add Character</button>
      </div>
    </div>

    <div id="cards" class="cards" aria-live="polite"></div>

    <div class="howto" id="howto">
      <h3>How to Use</h3>
      <ul>
        <li>Pick a preset (or make a new one).</li>
        <li>Type your Character Name. Use the Accents button if you need special letters.</li>
        <li>Wait a moment for image, job, and level to fill in, or upload an avatar.</li>
        <li>Check off your daily tasks.</li>
        <li>Save your changes so everything is ready for next time.</li>
      </ul>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <template id="accentsTemplate">
    <div class="accents-panel" role="dialog" aria-label="Accented characters">
      <div class="accents-grid" data-role="bases"></div>
      <div class="accents-variants" data-role="variants"></div>
      <div class="hint" data-role="hint" hidden>Click into a text box first</div>
    </div>
  </template>

  <script>
    // State
    const state = {
      theme: localStorage.getItem('theme') || 'theme-light',
      presets: loadPresets(),
      activePresetId: localStorage.getItem('activePresetId') || null,
      accentsOpenFor: null, // cardId
      nameLookupDebounce: null,
      nameLookupVersion: 0,
      pauseLookup: false,
    };

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function uid() { return Math.random().toString(36).slice(2, 10); }

    function loadPresets() {
      try { return JSON.parse(localStorage.getItem('presets')||'{}'); } catch { return {}; }
    }

    function savePresets() { localStorage.setItem('presets', JSON.stringify(state.presets)); }

    function ensureDefaultPreset() {
      if (!state.activePresetId || !state.presets[state.activePresetId]) {
        const id = uid();
        state.presets[id] = {
          id,
          name: 'Default',
          data: { characters: [] },
          updatedAt: Date.now()
        };
        state.activePresetId = id;
        savePresets();
        localStorage.setItem('activePresetId', id);
      }
    }

    // UTC Clock
    function startUTCClock() {
      const el = document.getElementById('utcTime');
      const tick = () => {
        const d = new Date();
        el.textContent = 'UTC — ' + d.toUTCString().split(' ')[4];
      };
      tick();
      setInterval(tick, 1000);
    }

    // Theming
    function applyTheme() {
      document.body.className = state.theme;
      localStorage.setItem('theme', state.theme);
    }

    function setupThemeSelector() {
      const sel = document.getElementById('themeSelect');
      sel.value = state.theme;
      sel.addEventListener('change', () => { state.theme = sel.value; applyTheme(); });
    }

    // Presets UI
    function renderPresetSelector() {
      const sel = document.getElementById('presetSelect');
      sel.innerHTML = '';
      Object.values(state.presets).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt);
      });
      sel.value = state.activePresetId;
      sel.addEventListener('change', () => {
        state.activePresetId = sel.value;
        localStorage.setItem('activePresetId', state.activePresetId);
        render();
      }, { once: true });
    }

    function getActivePreset() { return state.presets[state.activePresetId]; }

    function saveActivePreset(dataOverride) {
      const p = getActivePreset();
      if (!p) return;
      p.data = dataOverride || p.data;
      p.updatedAt = Date.now();
      savePresets();
      showToast('Preset saved');
      renderPresetSelector();
    }

    function loadActivePreset() {
      render();
      showToast('Preset loaded');
    }

    function renameActivePreset() {
      const p = getActivePreset();
      if (!p) return;
      const name = prompt('Preset name (max 12 chars):', p.name || 'Preset');
      if (name == null) return;
      const trimmed = name.trim();
      if (!trimmed) { showToast('Enter a name'); return; }
      if (trimmed.length > 12) { showToast('Limit 12 characters'); return; }
      if (Object.values(state.presets).some(x => x.id !== p.id && x.name.toLowerCase() === trimmed.toLowerCase())) { showToast('Name already in use'); return; }
      p.name = trimmed; p.updatedAt = Date.now(); savePresets(); renderPresetSelector(); showToast('Preset renamed');
    }

    // Cards
    function render() {
      ensureDefaultPreset();
      applyTheme();
      renderPresetSelector();

      const root = document.getElementById('cards');
      root.innerHTML = '';

      const p = getActivePreset();
      if (!p.data.characters) p.data.characters = [];

      p.data.characters.forEach(card => root.appendChild(renderCard(card)));
    }

    function renderCard(card) {
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.id = card.id;

      // Row: avatar + upload + delete
      const r1 = document.createElement('div'); r1.className = 'row';
      const avatarCol = document.createElement('div'); avatarCol.className = 'avatar-col';
      const img = document.createElement('img'); img.className = 'avatar'; img.alt = 'Character avatar'; img.loading = 'lazy';
      img.src = card.uploadedAvatarUrl || card.imageUrl || '';
      avatarCol.appendChild(img);

      const upload = document.createElement('input'); upload.type = 'file'; upload.accept = 'image/*'; upload.className = 'upload'; upload.title = 'Upload Avatar'; upload.setAttribute('aria-label', 'Upload Avatar');
      upload.addEventListener('change', e => {
        const file = upload.files && upload.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          card.uploadedAvatarUrl = reader.result;
          img.src = card.uploadedAvatarUrl;
          saveActivePreset();
        };
        reader.readAsDataURL(file);
      });
      avatarCol.appendChild(upload);

      const del = document.createElement('button'); del.className = 'btn'; del.textContent = 'Delete'; del.title = 'Delete character';
      del.addEventListener('click', () => handleDelete(card));
      avatarCol.appendChild(del);

      r1.appendChild(avatarCol);

      const nameCol = document.createElement('div'); nameCol.className = 'grow';
      const nameWrap = document.createElement('div'); nameWrap.className = 'name-input-wrap';
      const name = document.createElement('input'); name.type = 'text'; name.placeholder = 'Character Name'; name.value = card.name || ''; name.className = 'grow'; name.autocomplete = 'off'; name.maxLength = 20;

      // Debounced lookup on input (paused when accents open)
      name.addEventListener('input', () => {
        card.name = name.value;
        scheduleNameLookup(card, name);
        saveActivePreset();
      });

      // Accents button next to name
      const accentsBtn = document.createElement('button'); accentsBtn.className = 'accents-btn'; accentsBtn.title = 'Accents'; accentsBtn.setAttribute('aria-label', 'Accents'); accentsBtn.innerHTML = '<span class="glyph" aria-hidden="true">Á</span>';
      accentsBtn.addEventListener('click', (e) => toggleAccentsPanel(e.currentTarget, name, card));

      nameWrap.appendChild(name);
      nameWrap.appendChild(accentsBtn);

      // Meta pills
      const meta = document.createElement('div'); meta.className = 'meta';
      const jobP = pill('Job', card.job || '—');
      const lvlP = pill('Level', (card.level ?? '—'));
      const srvP = pill('Server', card.server || '—');
      meta.append(jobP.el, lvlP.el, srvP.el);

      nameCol.appendChild(nameWrap);
      nameCol.appendChild(meta);
      r1.appendChild(nameCol);

      // Tasks
      const r2 = document.createElement('div'); r2.className = 'tasks';
      const ul = document.createElement('ul'); ul.className = 'task-list'; ul.setAttribute('role','listbox');
      card.tasks = card.tasks || defaultTasks();
      card.tasks.forEach((t, idx) => {
        const li = document.createElement('li'); li.className = 'task-item'; li.tabIndex = 0; li.dataset.index = String(idx);
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!t.done; cb.setAttribute('aria-label', t.text);
        cb.addEventListener('change', () => { t.done = cb.checked; saveActivePreset(); });
        const label = document.createElement('div'); label.className = 'task-text'; label.textContent = t.text;

        li.appendChild(cb); li.appendChild(label);

        // Keyboard navigation for tasks
        li.addEventListener('keydown', (ev) => handleTaskKeydown(ev, ul));
        ul.appendChild(li);
      });
      r2.appendChild(ul);

      el.appendChild(r1);
      el.appendChild(r2);

      // Store refs for later updates
      el._refs = { img, jobP, lvlP, nameInput: name };
      return el;
    }

    function pill(labelText, valueText) {
      const el = document.createElement('div'); el.className = 'pill';
      const label = document.createElement('span'); label.className = 'label'; label.textContent = labelText + ':';
      const value = document.createElement('span'); value.className = 'value'; value.textContent = valueText;
      el.append(label, value);
      return { el, value };
    }

    function defaultTasks() {
      return [
        { text: 'Daily Bosses', done: false },
        { text: 'Commissions', done: false },
        { text: 'Event Tasks', done: false },
      ];
    }

    // Delete handling with popup-blocker notice
    function handleDelete(card) {
      let testWin = null;
      try { testWin = window.open('', '', 'width=1,height=1'); } catch {}
      if (!testWin) { showToast('This action requires pop ups. Please allow pop ups for this site and try again.'); return; }
      testWin.close();
      const ok = confirm(`Delete the character: ${card.name || 'Unnamed'}?`);
      if (!ok) return;
      const p = getActivePreset();
      p.data.characters = p.data.characters.filter(c => c.id !== card.id);
      saveActivePreset();
      render();
    }

    // Task keyboard navigation
    function handleTaskKeydown(ev, listEl) {
      const items = $$('.task-item', listEl);
      const idx = items.indexOf(ev.currentTarget);
      if (ev.key === 'ArrowDown') { ev.preventDefault(); items[Math.min(idx+1, items.length-1)].focus(); }
      else if (ev.key === 'ArrowUp') { ev.preventDefault(); items[Math.max(idx-1, 0)].focus(); }
      else if (ev.key === ' ' || ev.key === 'Enter') {
        // Enter currently toggles too; if you change this behavior later, adjust here
        ev.preventDefault(); const cb = ev.currentTarget.querySelector('input[type="checkbox"]'); if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', { bubbles: true })); }
      }
    }

    // Name lookup with debounce, pause while accents open, ignore stale responses
    function scheduleNameLookup(card, inputEl) {
      if (state.pauseLookup) return; // paused while the panel is open
      if (state.nameLookupDebounce) clearTimeout(state.nameLookupDebounce);
      const version = ++state.nameLookupVersion;
      state.nameLookupDebounce = setTimeout(async () => {
        const name = (card.name || '').trim();
        if (!name || name.length < 3) return;
        const result = await fetchMapleRanks(name).catch(() => null);
        if (version !== state.nameLookupVersion) return; // stale
        const cardEl = document.querySelector(`.card[data-id="${card.id}"]`);
        if (!cardEl) return;
        const { img, jobP, lvlP } = cardEl._refs;

        if (!result) {
          jobP.value.textContent = 'Character not found on MapleRanks';
          jobP.value.classList.add('soft-red');
          return;
        }
        jobP.value.classList.remove('soft-red');
        jobP.value.textContent = result.job || '—';
        lvlP.value.textContent = result.level ?? '—';
        if (!card.uploadedAvatarUrl && result.imageUrl && inputEl.value.trim() === name) {
          card.imageUrl = result.imageUrl;
          const tmp = new Image();
          tmp.onload = () => { img.src = result.imageUrl; };
          tmp.src = result.imageUrl;
        }
        saveActivePreset();
      }, 500);
    }

    // Mock MapleRanks fetch — replace with real service
    async function fetchMapleRanks(name) {
      await new Promise(r => setTimeout(r, 350));
      const lower = name.toLowerCase();
      if (lower.includes('zzz') || lower.length < 3) return null;
      return {
        job: ['Adele','Night Lord','Hero','Bishop','Kanna','Mechanic'][Math.floor(Math.random()*6)],
        level: 200 + Math.floor(Math.random()*100),
        imageUrl: `https://api.dicebear.com/8.x/adventurer/svg?seed=${encodeURIComponent(name)}`,
      };
    }

    // Accents keyboard
    const BASES = {
      'A': ['Á','À','Â','Ä','Ã','Å','Ā','Ă','Ą','á','à','â','ä','ã','å','ā','ă','ą'],
      'C': ['Ç','Ć','Č','ç','ć','č'],
      'E': ['É','È','Ê','Ë','Ē','Ė','Ę','é','è','ê','ë','ē','ė','ę'],
      'I': ['Í','Ì','Î','Ï','Ī','Į','í','ì','î','ï','ī','į'],
      'N': ['Ñ','Ń','Ň','ñ','ń','ň'],
      'O': ['Ó','Ò','Ô','Ö','Õ','Ō','Ő','Ø','ó','ò','ô','ö','õ','ō','ő','ø'],
      'U': ['Ú','Ù','Û','Ü','Ū','Ű','ú','ù','û','ü','ū','ű'],
      'Y': ['Ý','Ÿ','ý','ÿ'],
      'S': ['Ś','Š','Ş','ś','š','ş'],
      'Z': ['Ź','Ž','Ż','ź','ž','ż'],
      'L': ['Ł','ł']
    };

    function toggleAccentsPanel(buttonEl, inputEl, card) {
      const openFor = state.accentsOpenFor;
      const alreadyOpen = openFor === card.id;
      if (alreadyOpen) { closeAccentsPanel(); return; }
      openAccentsPanel(buttonEl, inputEl, card);
    }

    function openAccentsPanel(anchorBtn, inputEl, card) {
      closeAccentsPanel();
      state.pauseLookup = true; // pause lookups while the panel is open
      state.accentsOpenFor = card.id;

      const tpl = document.getElementById('accentsTemplate');
      const panel = tpl.content.firstElementChild.cloneNode(true);
      document.body.appendChild(panel);

      const r = anchorBtn.getBoundingClientRect();
      panel.style.top = `${r.bottom + window.scrollY + 6}px`;
      panel.style.left = `${r.left + window.scrollX}px`;

      const basesEl = panel.querySelector('[data-role="bases"]');
      const variantsEl = panel.querySelector('[data-role="variants"]');
      const hintEl = panel.querySelector('[data-role="hint"]');

      Object.keys(BASES).forEach(base => {
        const b = document.createElement('button');
        b.className = 'accents-base';
        b.type = 'button';
        b.textContent = base;
        b.addEventListener('click', () => {
          variantsEl.innerHTML = '';
          BASES[base].forEach(ch => {
            const c = document.createElement('button'); c.className = 'accents-char'; c.type = 'button'; c.textContent = ch;
            c.addEventListener('click', () => {
              insertCharAtCursor(inputEl, ch);
              closeAccentsPanel(true); // close after insertion
            });
            variantsEl.appendChild(c);
          });
          variantsEl.classList.add('open');
          variantsEl.firstElementChild?.focus();
        });
        basesEl.appendChild(b);
      });

      if (document.activeElement !== inputEl) hintEl.hidden = false;

      setTimeout(() => {
        const onKey = (e) => { if (e.key === 'Escape') closeAccentsPanel(); };
        const onClickAway = (e) => { const panelEl = document.querySelector('.accents-panel'); if (panelEl && !panelEl.contains(e.target) && e.target !== anchorBtn) closeAccentsPanel(); };
        document.addEventListener('keydown', onKey, { capture: true, once: true });
        document.addEventListener('mousedown', onClickAway, { capture: true });
        panel._cleanup = () => { document.removeEventListener('mousedown', onClickAway, { capture: true }); };
      }, 0);

      panel._anchor = anchorBtn;
      panel._input = inputEl;
      panel.setAttribute('aria-modal', 'true');
      anchorBtn.setAttribute('aria-expanded', 'true');
    }

    function closeAccentsPanel(fromInsert=false) {
      const panel = document.querySelector('.accents-panel');
      if (panel && panel._cleanup) panel._cleanup();
      if (panel && panel._anchor) panel._anchor.setAttribute('aria-expanded', 'false');
      panel?.remove();
      state.accentsOpenFor = null;
      setTimeout(() => { state.pauseLookup = false; }, fromInsert ? 250 : 0);
    }

    function insertCharAtCursor(input, ch) {
      const start = input.selectionStart ?? input.value.length;
      const end = input.selectionEnd ?? input.value.length;
      const before = input.value.slice(0, start);
      const after = input.value.slice(end);
      input.value = before + ch + after;
      input.setSelectionRange(start + ch.length, start + ch.length);
      input.dispatchEvent(new Event('input', { bubbles: true }));
      input.focus();
    }

    // Global Alt+A shortcut to open panel for focused field
    document.addEventListener('keydown', (e) => {
      if (e.altKey && (e.key === 'a' || e.key === 'A')) {
        const focused = document.activeElement;
        if (!(focused instanceof HTMLInputElement) && !(focused instanceof HTMLTextAreaElement)) {
          showToast('Click into a text box first');
          return;
        }
        const card = focused.closest('.card');
        if (!card) return;
        const btn = card.querySelector('.accents-btn');
        if (btn) { e.preventDefault(); openAccentsPanel(btn, focused, { id: card.dataset.id }); }
      }
    });

    // Shortcuts button toggle
    const scBtn = document.getElementById('shortcutsBtn');
    const scPanel = document.getElementById('shortcutsPanel');
    scBtn.addEventListener('click', () => {
      scPanel.hidden = !scPanel.hidden;
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !scPanel.hidden) scPanel.hidden = true;
    });

    // Toast helper
    let toastTimer = null;
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      clearTimeout(toastTimer); toastTimer = setTimeout(() => { t.style.display = 'none'; }, 2200);
    }

    // Add character
    function addCharacter() {
      const p = getActivePreset();
      p.data.characters.push({ id: uid(), name: '', job: '', level: '', imageUrl: '', uploadedAvatarUrl: '', tasks: defaultTasks() });
      saveActivePreset();
      render();
    }

    // Wire up top-level controls
    function setupTopControls() {
      document.getElementById('addCharacter').addEventListener('click', addCharacter);
      document.getElementById('savePreset').addEventListener('click', () => saveActivePreset(getActivePreset().data));
      document.getElementById('loadPreset').addEventListener('click', () => loadActivePreset());
      document.getElementById('renamePreset').addEventListener('click', renameActivePreset);
      document.getElementById('presetSelect').addEventListener('change', (e) => {
        state.activePresetId = e.target.value; localStorage.setItem('activePresetId', state.activePresetId); render();
      });
    }

    // Init
    ensureDefaultPreset();
    startUTCClock();
    setupThemeSelector();
    setupTopControls();
    render();
  </script>
</body>
</html>
